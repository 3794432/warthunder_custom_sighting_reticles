"use strict";(self.webpackChunkwt_wiki_3=self.webpackChunkwt_wiki_3||[]).push([[76],{641:(e,t,i)=>{var n=i(648),s=i(202);class r{constructor(e){this.post_id=e}async bookmark(e){var t=new FormData;return t.append("post_id",this.post_id),t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),!0===e?t.append("flag",1):t.append("flag",0),(0,s.A)("/api/bookmark",{method:"POST",credentials:"include",body:t}).then((e=>{if(e.success)return e;throw new Error(e.message)}))}}var a=i(400);const o="feed";class l{static init(e,t={}){for(var i in e.dataset)if(i.startsWith("feed")){var n=i.slice(4);t[n=(n=n.charAt(0).toLowerCase()+n.slice(1)).replace(/[A-Z]/g,(e=>"_"+e.toLowerCase()))]=e.dataset[i]}return new l(e,t)}constructor(e,t={}){if(this.atributes=t,this.id=this.atributes.id||null,delete this.atributes.id,!this.id)return;this.entryIds=[],this.nodes={root:e,itemsContainer:e.querySelector(`.${o}__items`),btnLoadNew:e.querySelector(`.${o}__load-new`),blockEndList:e.querySelector(`.${o}__end-entry`),blockEmpty:e.querySelector(`.${o}__empty`)};let i=this.nodes.root.querySelectorAll(`.${o}__items > *`);if(i.forEach((e=>{this._initFeedItem(e)})),this.start=this.atributes.start??Math.floor(Date.now()/1e3),delete this.atributes.start,"false"===this.atributes.hasmore)this.nodes.btnLoadNew.classList.add("d-none"),this.nodes.blockEmpty&&0===i.length?this.nodes.blockEmpty.classList.remove("d-none"):this.nodes.blockEndList.classList.remove("d-none");else if(this.nodes.btnLoadNew.addEventListener("click",(()=>{this.more()})),i.length>0){let e=i[i.length-1];this.observeScroll(e)}else this.observeScroll(this.nodes.btnLoadNew);delete this.atributes.hasmore}_initFeedItem(e){if(e.hasAttribute("data-entry-id")&&this.entryIds.push(e.getAttribute("data-entry-id")),e.classList.contains("post")){let t=Number(e.getAttribute("data-feed-pid"));if(t<=0)return;let i=new r(t);e.querySelectorAll(".post-bookmark").forEach((t=>{t.addEventListener("click",(()=>{if(e.bookmarkSend)return;if(null===window.app.getLoginUser())return void window.app.info(window.app.l10n("unauthorized-error.bookmark"));let t;t=!e.classList.contains("post--with-bookmark"),e.bookmarkSend=!0,i.bookmark(t).then((t=>{e.classList.toggle("post--with-bookmark",t.data.bookmark);let i=window.app.getLang();e.querySelectorAll(".post-bookmark .value").forEach((e=>{e.innerText=new Intl.NumberFormat(i).format(t.data.count)})),e.bookmarkSend=!1})).catch((t=>{window.app.error(t.message),e.bookmarkSend=!1}))}))}))}}observeScroll(e){if(!this.observer){let e={threshold:.5};this.observer=new IntersectionObserver(((e,t)=>{e.forEach((e=>{e.isIntersecting&&(this.more(),t.unobserve(e.target))}))}),e)}this.observer.observe(e)}_isLoadingMore=!1;async more(){if(this._isLoadingMore)return;this._isLoadingMore=!0,this.nodes.btnLoadNew.classList.add("loading");let e=this.nodes.btnLoadNew.innerText;this.nodes.btnLoadNew.innerHTML=a.A;let t=new URL(`/api/feed/${this.id}`,window.location.origin),i=this.nodes.root.querySelectorAll(`.${o}__items > *`);i.length>0&&t.searchParams.set("offset",i.length),t.searchParams.set("start",this.start);for(let e in this.atributes)null!==this.atributes[e]&&t.searchParams.set(e,this.atributes[e]);return(0,s.A)(t).then((e=>{let t=0;e.entries.forEach((e=>{let i=document.createElement("template");i.innerHTML=e;let n=i.content.firstChild;n&&(n.hasAttribute("data-entry-id")&&this.entryIds.includes(n.getAttribute("data-entry-id"))||(this.nodes.itemsContainer.append(n),this._initFeedItem(n),t++))})),e.hasMore&&t>0?this.observeScroll(this.nodes.itemsContainer.lastChild):(this.nodes.btnLoadNew.classList.add("d-none"),this.nodes.blockEmpty&&i.length+t===0?this.nodes.blockEmpty.classList.remove("d-none"):this.nodes.blockEndList.classList.remove("d-none"))})).finally((()=>{this._isLoadingMore=!1,this.nodes.btnLoadNew.classList.remove("loading"),this.nodes.btnLoadNew.innerText=e}))}refresh(){this.nodes.blockEmpty?.classList.add("d-none"),this.nodes.blockEndList?.classList.add("d-none"),this.nodes.btnLoadNew?.classList.remove("d-none"),this.nodes.itemsContainer.innerHTML="",this.more()}}class d{static init(){0!==document.querySelectorAll(".block-image, .block-gallery").length&&window.app.loadModule("photoswipe").then((({default:e})=>{const t=new e.PhotoSwipeLightbox({gallery:".block-image .block-image__container a",pswpModule:e.PhotoSwipe});t.on("uiRegister",(function(){t.pswp.ui.registerElement(e.downloadButtonConfig)})),t.init();const i=new e.PhotoSwipeLightbox({gallery:".block-gallery .block-gallery__container",children:"a",pswpModule:e.PhotoSwipe});i.on("uiRegister",(function(){i.pswp.ui.registerElement(e.downloadButtonConfig)})),i.init()}));let e=document.querySelectorAll(".block-gallery__container.swiper");0!==e.length&&window.app.loadModule("swiper").then((({default:t})=>{e.forEach((e=>{new t.Swiper(e,{slidesPerView:"auto",spaceBetween:30,centeredSlides:!0,pagination:{el:".swiper-pagination",clickable:!0}})}))}));let t=document.querySelectorAll(".block-panorama");0!==t.length&&window.app.loadModule("pannellum").then((({default:e})=>{t.forEach((e=>{let t=e.querySelector(".block-panorama_container");t.hasAttribute("data-url")&&(t.innerHTML="",t.classList.remove("placeholder-glow"),window.pannellum.viewer(t,{type:"equirectangular",panorama:t.getAttribute("data-url"),strings:window.app.l10n("pannellum")}))}))}));let i=document.querySelector(".content");i&&(i.addEventListener("click",(e=>{let t=e.target.closest("span.cdx-annotation");t&&(t.classList.contains("active")?d.closeAnnotationPopover():d.openAnnotationPopover(t))})),document.addEventListener("click",(e=>{let t=e.target.closest("span.cdx-annotation"),i=e.target.closest(".c-annotation_block");t||i||d.closeAnnotationPopover()})),window.addEventListener("scroll",(()=>{d.closeAnnotationPopover()})))}static getAnnotationPopover(){let e=document.getElementById("c-annotation");if(!e){e=document.createElement("div"),e.id="c-annotation",e.classList.add("c-annotation","hidden");let t=document.createElement("div");t.classList.add("c-annotation_overlay");let i=document.createElement("div");i.classList.add("c-annotation_block");let n=document.createElement("div");n.classList.add("c-annotation_title");let s=document.createElement("div");s.classList.add("c-annotation_content","content-markdown"),i.appendChild(n),i.appendChild(s),e.appendChild(t),e.appendChild(i),document.querySelector(".content").after(e)}return e}static getFromNodePos(e,t){for(var i=0,n=0;i+=e.offsetLeft,n+=e.offsetTop,null!==e.offsetParent&&e.offsetParent!==t;)e=e.offsetParent;return[i,n]}static openAnnotationPopover(e){e.classList.add("active");let t=d.getAnnotationPopover(),i=t.querySelector(".c-annotation_title");i&&(e.hasAttribute("data-title")?i.innerText=e.getAttribute("data-title"):i.innerText="");let n=t.querySelector(".c-annotation_content");n&&(e.hasAttribute("data-html")?n.innerHTML=e.getAttribute("data-html"):n.innerHTML="");let s=d.getFromNodePos(e,e.closest(".content").parentElement);t.style.top=s[1]-90+"px",t.classList.remove("hidden")}static closeAnnotationPopover(){document.querySelectorAll("span.cdx-annotation.active").forEach((e=>{e.classList.remove("active")}));let e=document.getElementById("c-annotation");e&&e.classList.add("hidden")}}class c{constructor(e){this.post_id=e}async vote(e){var t=new FormData;return t.append("post_id",this.post_id),t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),!0===e?t.append("vote",1):!1===e?t.append("vote",-1):null===e?t.append("vote",0):reject({success:!1,message:window.app.l10n("core.bad-request-error")}),(0,s.A)("/api/vote",{method:"POST",credentials:"include",body:t}).then((e=>{if(e.success)return e;throw new Error(e.message)}))}}var u=i(336),h=i(41),m=i(267);class p{constructor(e,t){this.commentsSection=t,this.postId=e;let i=t.querySelector(".comments-writing .comment-form");i&&(this._initCommentForm(i),this.commentForm=i);let n=t.querySelector(".comments-content");this.commentsContent=n,document.querySelectorAll(".comment").forEach((e=>{this._initComment(e)})),n.addEventListener("click",(e=>{if(e.target.closest(".comment_reply")){var t=e.target.closest(".comment"),i=t.querySelector(".comment-form");i?i.classList.toggle("d-none"):this._getReplyForm(t).setAttribute("data-reply",t.getAttribute("data-comment-id"))}})),n.addEventListener("click",(e=>{let t=e.target.closest(".comment_add-reaction .comment_button");if(t&&null===window.app.getLoginUser())return u.Dropdown.getOrCreateInstance(t).hide(),void window.app.info(window.app.l10n("unauthorized-error.vote"))})),n.addEventListener("click",(e=>{let t=e.target.closest(".comment_reaction-button");if(t){let i=e.target.closest(".comment"),n=parseInt(i.getAttribute("data-comment-id")),s=parseInt(t.getAttribute("data-reaction-id"));this.reaction(n,s)}})),document.addEventListener("click",(e=>{var t=e.target.closest("[data-menu-id]");if(!t)return;let i=e.target.closest(".comment");if(!i)return;let n=t.getAttribute("data-menu-id");switch(n){case"pin":case"unpin":this._pin(i.getAttribute("data-comment-id"),n);break;case"delete":this._delete(i.getAttribute("data-comment-id"));break;case"edit":this._fillCommentSource(i)}})),n.addEventListener("click",(e=>{let t=e.target.closest("[data-reply-comment-id]");if(t){let i=t.getAttribute("data-reply-comment-id"),n=document.getElementById(`comment_${i}`);n&&(e.preventDefault(),n.classList.add("comment--highlight"),window.location.hash=`#comment_${i}`,setTimeout((()=>n.classList.remove("comment--highlight")),500))}})),this.isSliceShow=t.hasAttribute("data-comment"),this.isSliceShow||new IntersectionObserver(((e,t)=>{e.forEach((e=>{e.isIntersecting&&(this.loadMoreThreads(),t.unobserve(e.target))}))}),{threshold:0}).observe(t),"moderation"===this.commentsSection.getAttribute("data-section")&&n.addEventListener("click",(e=>{let t=e.target.closest(".comment_moderation-button");if(t){let i=e.target.closest(".comment"),n=t.getAttribute("data-action");this._moderation(i,n)}}));let s=t.querySelector(".comment-update");s&&(s.addEventListener("click",(()=>{this.loadMoreThreads()})),this.buttonCommentUpdate=s),document.addEventListener("app.comment.mod.delete",(e=>{let t=e=>{let t=e.closest(".comments-thread"),i=e.closest(".comments-branch");i?(e.remove(),i&&0==i.childElementCount&&i.remove()):t&&t.childElementCount<=1?t.remove():(e.style.filter="blur(5px)",e.style.pointerEvents="none")},i=e.detail,n=document.querySelector(`[data-comment-id="${i.commentId}"]`);n&&t(n),i.affectedIds&&i.affectedIds.forEach((e=>{let i=document.querySelector(`[data-comment-id="${e}"]`);i&&t(i)}))}))}_initCommentForm(e){new m.A(e,{target:"p-c_"+this.postId,onSend:async(e,t)=>{let i={};return t.hasAttribute("data-edit")?i.edit_id=t.getAttribute("data-edit"):(t.hasAttribute("data-reply")&&(i.reply=t.getAttribute("data-reply")),t.hasAttribute("data-section")&&(i.section=t.getAttribute("data-section"))),"text"in e&&(i.text=e.text.trim()),"img-uuid"in e&&(i["img-uuid"]=e["img-uuid"]),this.sendComment(i)}})}_initComment(e){let t=e.querySelector(".comment_image");t&&window.app.loadModule("photoswipe").then((({default:e})=>{const i=new e.PhotoSwipeLightbox({gallery:t,pswpModule:e.PhotoSwipe});i.on("uiRegister",(function(){i.pswp.ui.registerElement(e.downloadButtonConfig)})),i.init()}));let i=e.querySelector(".comment_add-reaction");if(i&&e.hasAttribute("data-reaction-id")){let t=parseInt(e.getAttribute("data-reaction-id")),n=e.querySelector(`.comment_reaction-button[data-reaction-id="${t}"]`);if(n){i.classList.add("d-none");let t=document.createElement("button");t.classList.add("comment_button","comment_remove-reaction"),t.innerHTML=n.innerHTML,t.addEventListener("click",(()=>{this.reaction(e.getAttribute("data-comment-id"),null)})),i.parentElement.prepend(t)}}let n=e.querySelector(".comment_text");n&&"height-cropper"===n.getAttribute("data-module")&&h.A.call(n),[...e.querySelectorAll('[data-bs-toggle="tooltip"]')].map((e=>new u.Tooltip(e,{trigger:"hover"})))}_lastTimestamp=null;_doingMore=!1;async loadMoreThreads(){if(this.isSliceShow)return;if(this._doingMore)return;this._doingMore=!0,this.buttonCommentUpdate&&(this.buttonCommentUpdate.dataLabel=this.buttonCommentUpdate.innerText,this.buttonCommentUpdate.innerHTML=a.A);let e=new FormData;e.append(window.app.getCSRFParam(),window.app.getCSRFToken()),e.append("post_id",this.postId),e.append("section",this.commentsSection.getAttribute("data-section"));let t=this.commentsSection.querySelector("#post-comment-sort");if(t){let i=t.querySelector(".dropdown-item.active");i&&e.append("sort",i.getAttribute("data-sort-id"))}this._lastTimestamp&&e.append("timestamp",this._lastTimestamp);let i=this.commentsContent.querySelectorAll(".comments-thread:not(.comments-thread--pinned)").length;return i>0&&e.append("offset",i),(0,s.A)("/api/commentsGetThreads",{method:"POST",credentials:"include",body:e}).then((e=>{e.success?this._renderMoreThreads(e.data):window.app.error(e.message)})).finally((e=>{this._doingMore=!1,this.buttonCommentUpdate&&(this.buttonCommentUpdate.innerText=this.buttonCommentUpdate.dataLabel)}))}_renderMoreThreads(e){let t=this.commentsContent.querySelectorAll(".comments-thread:not(.comments-thread--pinned) > .comment"),i=[];t.forEach((e=>{i.push(parseInt(e.getAttribute("data-comment-id")))})),e.items.forEach((e=>{if(-1!==i.indexOf(e.id))return;let t=document.createElement("div");if(t.classList.add("comments-thread"),t.innerHTML=e.html,this.commentsContent.appendChild(t),this._initComment(t.lastChild),e.child_items){let i=document.createElement("div");i.classList.add("comments-branch"),e.child_items.forEach((e=>{i.insertAdjacentHTML("beforeEnd",e.html),this._initComment(i.lastChild)}));let n=e.total_items-e.child_items.length;if(n>0){let t=document.createElement("button");t.classList.add("btn","btn-link","comments-more"),t.innerText=window.app.l10n("comment.load_more",{count:n}),t.addEventListener("click",(()=>{let i=document.createElement("span");i.className="spinner-border spinner-border-sm me-2",i.role="status",t.prepend(i),this.loadBranch(e.id).finally((()=>{t.remove()}))})),i.appendChild(t)}t.appendChild(i)}}));let n=e.threads-i.length-e.items.length;if(n>0){let e=document.createElement("button");e.classList.add("btn","btn-link","comments-more"),e.innerText=window.app.l10n("comment.load_more",{count:n}),e.addEventListener("click",(()=>{let t=document.createElement("span");t.className="spinner-border spinner-border-sm me-2",t.role="status",e.prepend(t),this.loadMoreThreads().finally((()=>{e.remove()}))})),this.commentsContent.appendChild(e)}}async loadBranch(e){if(this.isSliceShow)return;let t=this.commentsContent.querySelector(`.comments-thread > #comment_${e}`);if(!t)return;if(t._doingMore)return;t._doingMore=!0;let i=t.parentElement,n=new FormData;n.append(window.app.getCSRFParam(),window.app.getCSRFToken()),n.append("root_id",e);let r=i.querySelectorAll(".comments-branch .comment"),a=[];return r.forEach((e=>{a.push(parseInt(e.getAttribute("data-comment-id")))})),n.append("offset",r.length),(0,s.A)("/api/commentsGetBranch",{method:"POST",credentials:"include",body:n}).then((t=>{if(t.success){let n=i.querySelector(".comments-branch");n||(n=document.createElement("div"),n.className="comments-branch",i.appendChild(n)),t.data.items.forEach((e=>{-1===a.indexOf(e.id)&&(n.insertAdjacentHTML("beforeEnd",e.html),this._initComment(n.lastChild))}));let s=t.data.total_items-t.data.items.length-r;if(s>0){let t=document.createElement("button");t.classList.add("btn","btn-link","comments-more"),t.innerText=window.app.l10n("comment.load_more",{count:s}),t.addEventListener("click",(()=>{let i=document.createElement("span");i.className="spinner-border spinner-border-sm me-2",i.role="status",t.prepend(i),this.loadBranch(e).finally((()=>{t.remove()}))})),n.appendChild(t)}}else window.app.error(t.message)})).finally((e=>{t._doingMore=!1}))}async sendComment(e){if(!("text"in e&&0!==e.text.trim().length||"img-uuid"in e))return window.app.warning(window.app.l10n("comment.error_empty")),Promise.reject();var t=new FormData;return t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t.append("post_id",this.postId),"text"in e&&t.append("text",e.text.trim()),"img-uuid"in e&&t.append("img-uuid",e["img-uuid"]),"section"in e&&t.append("section",e.section),"reply"in e&&t.append("reply",e.reply),"edit_id"in e&&t.append("edit_id",e.edit_id),(0,s.A)("/api/commentSend",{method:"POST",credentials:"include",body:t}).then((e=>{if(e.success)if(e?.data?.newHTML){let t=this.commentsSection.querySelector(`.comment[data-comment-id="${e.data.commentId}"]`);t?(t.outerHTML=e.data.newHTML,this._initComment(t)):window.location.reload()}else window.location.reload();else window.app.warning(e.message)}))}reaction(e,t){var i=new FormData;i.append(window.app.getCSRFParam(),window.app.getCSRFToken()),i.append("comment_id",e),i.append("reaction",null===t?-1:t),(0,s.A)("/api/commentReaction",{method:"POST",credentials:"include",body:i}).then((t=>{t.success?this.commentsContent.querySelectorAll(`[data-comment-id='${e}']`).forEach((e=>{e.querySelectorAll(".comment_reaction").forEach((e=>{let i=parseInt(e.getAttribute("data-reaction-id")),n=t.data.counters[i]||0;n>0?(e.classList.remove("d-none"),e.querySelector("span").innerText=n):i===t.data.reaction?(e.classList.remove("d-none"),e.querySelector("span").innerText=""):e.classList.add("d-none"),e.classList.toggle("active",i===t.data.reaction)}));let i=e.querySelector(".comment_add-reaction");if(e.querySelector(".comment_remove-reaction")?.remove(),null!==t.data.reaction){e.setAttribute("data-reaction-id",t.data.reaction),i?.classList.add("d-none");let n=e.querySelector(`.comment_reaction-button[data-reaction-id="${t.data.reaction}"]`);if(n){let t=document.createElement("button");t.classList.add("comment_button","comment_remove-reaction"),t.innerHTML=n.innerHTML,t.addEventListener("click",(()=>{this.reaction(e.getAttribute("data-comment-id"),null)})),i?.parentElement.prepend(t)}}else e.removeAttribute("data-reaction-id"),i?.classList.remove("d-none")})):window.app.error(t.message)}))}_fillCommentSource(e){let t=e.getAttribute("data-comment-id");var i=new FormData;i.append(window.app.getCSRFParam(),window.app.getCSRFToken()),i.append("comment_id",t),(0,s.A)("/api/commentGetSource",{method:"POST",credentials:"include",body:i}).then((i=>{if(i.success){let n=this._getReplyForm(e);n.classList.remove("d-none"),n.removeAttribute("data-reply"),n.setAttribute("data-edit",t);let s=e.querySelector(".comment_content"),r=e.querySelector(".comment_controls");s.classList.add("d-none"),r.classList.add("d-none");let a=JSON.parse(i.data?.source),o=n.querySelector(".comment-form_input");a.text?o.value=a.text:o.value="",n.resizeHeight();let l=n.querySelector(".comment-form_upload-file"),d=n.querySelector(".comment-form_attach-img");if(a.image){l.classList.add("d-none"),d.classList.remove("d-none"),n.setAttribute("data-img-uuid",a.image);let t=e.querySelector(".comment_image img")?.src;d.style.backgroundImage=`url(${t})`}else l.classList.remove("d-none"),d.classList.add("d-none"),n.removeAttribute("data-img-uuid");let c=document.createElement("button");c.className="btn btn-sm btn-danger bi bi-x-lg",c.addEventListener("click",(()=>{s.classList.remove("d-none"),r.classList.remove("d-none"),o.value="",n.removeAttribute("data-edit"),n.removeAttribute("data-img-uuid"),n.classList.add("d-none"),l.classList.remove("d-none"),d.classList.add("d-none"),c.remove()})),n.querySelector(".comment-form_send").before(c)}else window.app.error(i.message)}))}_getReplyForm(e){var t=e.querySelector(".comment-form");if(!t){var i=this.commentForm.cloneNode(!0);e.appendChild(i),this._initCommentForm(i),t=i}return t}_delete(e){var t=new FormData;t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t.append("comment_id",e),(0,s.A)("/api/commentDelete",{method:"POST",credentials:"include",body:t}).then((t=>{if(t.success){window.app.success(window.app.l10n("comment.deleted"));let i=this.commentsSection.querySelector(`.comment[data-comment-id="${e}"]`);if(i)if(t?.data?.newHTML)i.outerHTML=t.data.newHTML;else{let e=i.closest(".comments-thread"),t=i.closest(".comments-branch");i.remove(),t&&0==t.childElementCount&&t.remove(),e&&0==e.childElementCount&&e.remove()}}else window.app.error(t.message)}))}_pin(e,t){var i=new FormData;i.append(window.app.getCSRFParam(),window.app.getCSRFToken()),i.append("comment_id",e),i.append("post_id",this.postId),i.append("action",t),(0,s.A)("/api/commentPin",{method:"POST",credentials:"include",body:i}).then((e=>{e.success?window.location.reload():window.app.error(e.message)}))}_moderation(e,t){let i=e.getAttribute("data-comment-id");var n=new FormData;n.append(window.app.getCSRFParam(),window.app.getCSRFToken()),n.append("comment_id",i),n.append("post_id",this.postId),n.append("action",t),(0,s.A)("/api/commentModeration",{method:"POST",credentials:"include",body:n}).then((t=>{t.success?e.parentElement.remove():window.app.error(t.message)}))}}var g=i(252),f=i(86),v=i(193);const w="wiki-editor",b=`${w}__initial`,y=`${w}__title`,S=`${w}__instance`,_=`${w}__tags`,L=`${w}__entities`,k=`${w}__save`,E=`${w}__preview`,T=`${w}__review`,C=`${w}__typograf`,A=`${w}__save-status`,x=`${w}__saved`,I=`${w}__save-time`,M=`${w}__history`,P=`${w}__modal-history`,q=`${w}_modal-review`,B=`${w}_review-require`,F=`${w}_review-require-sym`,N=`${w}_review-require-img`,R=`${w}_review-require-tag`;class U{static getPosFromNode(e,t){let i=0,n=0;for(;i+=e.offsetLeft,n+=e.offsetTop,null!==e.offsetParent&&e.offsetParent!==t;)e=e.offsetParent;return[i,n]}constructor(e,t,i={}){this.container=e,this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.canvasXY=U.getPosFromNode(this.canvas,this.container),this.arrowPadding=i.hasOwnProperty("arrowPadding")?i.arrowPadding:4,this.arrowThickness=i.arrowThickness||8}getCtx(){return this.ctx}draw(e,t){let i=U.getPosFromNode(t,this.container),n=U.getPosFromNode(e,this.container),s=this.getCtx();if(Math.abs(n[1]-i[1])<=5){var r=Math.round(n[1]-this.canvasXY[1]+(e.clientHeight-e.clientHeight/2)-this.arrowThickness/2);if(i[0]>n[0]){var a=n[0]+e.clientWidth-3,o=Math.round(a-this.canvasXY[0]),l=i[0]-a+5-7;s.fillRect(o,r,l,this.arrowThickness),s.beginPath(),s.moveTo(o+l,r-3),s.lineTo(o+l+7,r+4),s.lineTo(o+l,r+11),s.fill()}}else if(Math.abs(n[0]-i[0])<=2){if(i[1]>n[1]){o=Math.round(n[0]-this.canvasXY[0]+e.clientWidth/2-this.arrowThickness/2);var d=n[1]+e.clientHeight+this.arrowPadding,c=(r=Math.round(d-this.canvasXY[1]),i[1]-d-this.arrowPadding-7);s.fillRect(o,r,this.arrowThickness,c),s.beginPath(),s.moveTo(o-3,r+c),s.lineTo(o+4,r+c+7),s.lineTo(o+11,r+c),s.fill()}}else{o=Math.round(n[0]-this.canvasXY[0]+e.clientWidth/2-this.arrowThickness/2),d=n[1]+e.clientHeight+this.arrowPadding,r=Math.round(d-this.canvasXY[1]);var u=i[1]-d-this.arrowPadding;t.classList.contains("wt-tree_group")&&(c+=4),s.fillRect(o,r,this.arrowThickness,4);var h=Math.round(i[0]-this.canvasXY[0]+t.clientWidth/2-this.arrowThickness/2);i[0]<n[0]?s.fillRect(h,r+4,Math.abs(h-o)+this.arrowThickness,this.arrowThickness):s.fillRect(o,r+4,Math.abs(h-o)+this.arrowThickness,this.arrowThickness);var m=u-this.arrowThickness-4-7,p=r+4+this.arrowThickness;s.fillRect(h,p,this.arrowThickness,m),s.beginPath(),s.moveTo(h-3,p+m),s.lineTo(h+4,p+m+7),s.lineTo(h+11,p+m),s.fill()}}}var H,O,D=i(282);class ${constructor(e,t,i){this.gameId=e,this.treeId=t,this.wrapperNode=i,this.compareButton=this.wrapperNode.querySelector("#game-unit_compare"),this.compareButtonLabel=this.compareButton.querySelector("span"),this.removeCompareButton=this.wrapperNode.querySelector("#game-unit_compare-remove");let n=this.getCompareList();this.setInclude(n.includes(this.gameId),n.length),this.compareButton.addEventListener("click",(()=>{let e=this.getCompareList();this.wrapperNode.classList.contains("game-unit_control-group")?window.open("/unit/compare?tree="+this.treeId):e.includes(this.gameId)||(e.length>=20?window.app.warning(window.app.l10n("game-unit.compare-limit")):(e.push(this.gameId),this.saveList(e),window.app.helper.yaMetrika("reachGoal","WIKI3_UBTN_COMPARE",{unit_id:this.gameId})))})),this.removeCompareButton.addEventListener("click",(()=>{let e=this.getCompareList();e=e.filter((e=>e!==this.gameId)),this.saveList(e)}))}getCompareList(){let e=window.app.getCookie("unitsCompare"),t=[];try{t=JSON.parse(e)}catch(e){t=[]}return Array.isArray(t)||(t=[]),t}saveList(e){0===e.length?window.app.deleteCookie("unitsCompare"):window.app.setCookie("unitsCompare",JSON.stringify(e)),this.setInclude(e.includes(this.gameId),e.length)}setInclude(e,t){this.wrapperNode.classList.toggle("game-unit_control-group",e),this.removeCompareButton.classList.toggle("d-none",!e),e?this.compareButtonLabel.innerHTML=window.app.l10n("game-unit.button-in-compare")+`<span class="badge bg-primary ms-1">${t}</span>`:this.compareButtonLabel.innerText=window.app.l10n("game-unit.button-compare")}}class V{constructor(e,t,i,n={}){if(this.unitId=e,this.rootNode=t,this.nominationId=t.getAttribute("data-nomination-id"),this.button=t.querySelector(".game-unit_score-button"),i||null===window.app.getLoginUser()?this.button.addEventListener("click",(()=>{null!==window.app.getLoginUser()?this.isProcess||(this.rootNode.hasAttribute("data-score")?this.setScore(0):this.rootNode.classList.toggle("vote-show")):window.GSEA?.open()})):this.button.remove(),t.querySelector(".game-unit_score-vote").addEventListener("click",(e=>{let t=e.target.closest("button");t&&t.hasAttribute("data-score")&&this.setScore(parseInt(t.getAttribute("data-score")))})),"score"in n&&this._setSelectedScore(n.score),"count"in n&&"sum"in n){let e=n.sum/n.count,t=Math.round(e),i=24*(e-1)+4,s=this.rootNode.querySelector(".game-unit_score-line");s.classList.remove("color-empty"),s.classList.add(`color-${t}`),s.style.width=i+"%";let r=this.rootNode.querySelector(".game-unit_score-stat"),a="game-unit.scores-stat-total";"last"===n.period&&(a="game-unit.scores-stat-last"),r.innerText=window.app.l10n(a,{count:n.count})}}isProcess=!1;setScore(e){if(this.isProcess)return;if(null===window.app.getLoginUser())return void window.app.info(window.app.l10n("unauthorized-error.vote"));this.isProcess=!0,this.rootNode.className="game-unit_score";let t=this.button.innerHTML;this.button.innerHTML=a.A;let i=new FormData;return i.append(window.app.getCSRFParam(),window.app.getCSRFToken()),i.append("unit_id",this.unitId),i.append("nomination",this.nominationId),i.append("score",e),(0,s.A)("/api/gunitScore",{method:"POST",credentials:"include",body:i}).then((e=>{e.success?this._setSelectedScore(e.data.score):window.app.error(e.message)})).catch((e=>this.button.innerHTML=t)).finally((()=>{this.isProcess=!1}))}_setSelectedScore(e){if(null===e)this.rootNode.removeAttribute("data-score"),this.button.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 -960 960 960" fill="currentColor"><path d="M342.001-278.616 480-383.924l137.999 105.308-52.153-169.692 137.614-98.307H534.154L480-725.537l-54.154 178.922H256.54l137.614 98.307-52.153 169.692Zm138.066 162.615q-74.836 0-141.204-28.42-66.369-28.42-116.182-78.21-49.814-49.791-78.247-116.129-28.433-66.337-28.433-141.173 0-75.836 28.42-141.704 28.42-65.869 78.21-115.682 49.791-49.814 116.129-78.247 66.337-28.433 141.173-28.433 75.836 0 141.704 28.42 65.869 28.42 115.682 78.21 49.814 49.791 78.247 115.629 28.433 65.837 28.433 141.673 0 74.836-28.42 141.204-28.42 66.369-78.21 116.182-49.791 49.814-115.629 78.247-65.837 28.433-141.673 28.433Z" /></svg>';else{this.rootNode.setAttribute("data-score",e),this.rootNode.classList.add("scored",`score-${e}`);let t=this.rootNode.querySelector(`.game-unit_score-vote button[data-score="${e}"]`);t&&(this.button.innerHTML=t.innerHTML)}}}function z(e){return"object"==typeof e&&"function"==typeof e.to}function j(e){e.parentElement.removeChild(e)}function G(e){return null!=e}function W(e){e.preventDefault()}function Z(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}function X(e,t,i){i>0&&(Q(e,t),setTimeout((function(){ee(e,t)}),i))}function J(e){return Math.max(Math.min(e,100),0)}function Y(e){return Array.isArray(e)?e:[e]}function K(e){var t=(e=String(e)).split(".");return t.length>1?t[1].length:0}function Q(e,t){e.classList&&!/\s/.test(t)?e.classList.add(t):e.className+=" "+t}function ee(e,t){e.classList&&!/\s/.test(t)?e.classList.remove(t):e.className=e.className.replace(new RegExp("(^|\\b)"+t.split(" ").join("|")+"(\\b|$)","gi")," ")}function te(e){var t=void 0!==window.pageXOffset,i="CSS1Compat"===(e.compatMode||"");return{x:t?window.pageXOffset:i?e.documentElement.scrollLeft:e.body.scrollLeft,y:t?window.pageYOffset:i?e.documentElement.scrollTop:e.body.scrollTop}}function ie(e,t){return 100/(t-e)}function ne(e,t,i){return 100*t/(e[i+1]-e[i])}function se(e,t){for(var i=1;e>=t[i];)i+=1;return i}!function(e){e.Range="range",e.Steps="steps",e.Positions="positions",e.Count="count",e.Values="values"}(H||(H={})),function(e){e[e.None=-1]="None",e[e.NoValue=0]="NoValue",e[e.LargeValue=1]="LargeValue",e[e.SmallValue=2]="SmallValue"}(O||(O={}));var re=function(){function e(e,t,i){var n;this.xPct=[],this.xVal=[],this.xSteps=[],this.xNumSteps=[],this.xHighestCompleteStep=[],this.xSteps=[i||!1],this.xNumSteps=[!1],this.snap=t;var s=[];for(Object.keys(e).forEach((function(t){s.push([Y(e[t]),t])})),s.sort((function(e,t){return e[0][0]-t[0][0]})),n=0;n<s.length;n++)this.handleEntryPoint(s[n][1],s[n][0]);for(this.xNumSteps=this.xSteps.slice(0),n=0;n<this.xNumSteps.length;n++)this.handleStepPoint(n,this.xNumSteps[n])}return e.prototype.getDistance=function(e){for(var t=[],i=0;i<this.xNumSteps.length-1;i++)t[i]=ne(this.xVal,e,i);return t},e.prototype.getAbsoluteDistance=function(e,t,i){var n,s=0;if(e<this.xPct[this.xPct.length-1])for(;e>this.xPct[s+1];)s++;else e===this.xPct[this.xPct.length-1]&&(s=this.xPct.length-2);i||e!==this.xPct[s+1]||s++,null===t&&(t=[]);var r=1,a=t[s],o=0,l=0,d=0,c=0;for(n=i?(e-this.xPct[s])/(this.xPct[s+1]-this.xPct[s]):(this.xPct[s+1]-e)/(this.xPct[s+1]-this.xPct[s]);a>0;)o=this.xPct[s+1+c]-this.xPct[s+c],t[s+c]*r+100-100*n>100?(l=o*n,r=(a-100*n)/t[s+c],n=1):(l=t[s+c]*o/100*r,r=0),i?(d-=l,this.xPct.length+c>=1&&c--):(d+=l,this.xPct.length-c>=1&&c++),a=t[s+c]*r;return e+d},e.prototype.toStepping=function(e){return function(e,t,i){if(i>=e.slice(-1)[0])return 100;var n=se(i,e),s=e[n-1],r=e[n],a=t[n-1],o=t[n];return a+function(e,t){return ne(e,e[0]<0?t+Math.abs(e[0]):t-e[0],0)}([s,r],i)/ie(a,o)}(this.xVal,this.xPct,e)},e.prototype.fromStepping=function(e){return function(e,t,i){if(i>=100)return e.slice(-1)[0];var n=se(i,t),s=e[n-1],r=e[n],a=t[n-1];return function(e,t){return t*(e[1]-e[0])/100+e[0]}([s,r],(i-a)*ie(a,t[n]))}(this.xVal,this.xPct,e)},e.prototype.getStep=function(e){return function(e,t,i,n){if(100===n)return n;var s=se(n,e),r=e[s-1],a=e[s];return i?n-r>(a-r)/2?a:r:t[s-1]?e[s-1]+function(e,t){return Math.round(e/t)*t}(n-e[s-1],t[s-1]):n}(this.xPct,this.xSteps,this.snap,e)},e.prototype.getDefaultStep=function(e,t,i){var n=se(e,this.xPct);return(100===e||t&&e===this.xPct[n-1])&&(n=Math.max(n-1,1)),(this.xVal[n]-this.xVal[n-1])/i},e.prototype.getNearbySteps=function(e){var t=se(e,this.xPct);return{stepBefore:{startValue:this.xVal[t-2],step:this.xNumSteps[t-2],highestStep:this.xHighestCompleteStep[t-2]},thisStep:{startValue:this.xVal[t-1],step:this.xNumSteps[t-1],highestStep:this.xHighestCompleteStep[t-1]},stepAfter:{startValue:this.xVal[t],step:this.xNumSteps[t],highestStep:this.xHighestCompleteStep[t]}}},e.prototype.countStepDecimals=function(){var e=this.xNumSteps.map(K);return Math.max.apply(null,e)},e.prototype.hasNoSize=function(){return this.xVal[0]===this.xVal[this.xVal.length-1]},e.prototype.convert=function(e){return this.getStep(this.toStepping(e))},e.prototype.handleEntryPoint=function(e,t){var i;if(!Z(i="min"===e?0:"max"===e?100:parseFloat(e))||!Z(t[0]))throw new Error("noUiSlider: 'range' value isn't numeric.");this.xPct.push(i),this.xVal.push(t[0]);var n=Number(t[1]);i?this.xSteps.push(!isNaN(n)&&n):isNaN(n)||(this.xSteps[0]=n),this.xHighestCompleteStep.push(0)},e.prototype.handleStepPoint=function(e,t){if(t)if(this.xVal[e]!==this.xVal[e+1]){this.xSteps[e]=ne([this.xVal[e],this.xVal[e+1]],t,0)/ie(this.xPct[e],this.xPct[e+1]);var i=(this.xVal[e+1]-this.xVal[e])/this.xNumSteps[e],n=Math.ceil(Number(i.toFixed(3))-1),s=this.xVal[e]+this.xNumSteps[e]*n;this.xHighestCompleteStep[e]=s}else this.xSteps[e]=this.xHighestCompleteStep[e]=this.xVal[e]},e}(),ae={to:function(e){return void 0===e?"":e.toFixed(2)},from:Number},oe={target:"target",base:"base",origin:"origin",handle:"handle",handleLower:"handle-lower",handleUpper:"handle-upper",touchArea:"touch-area",horizontal:"horizontal",vertical:"vertical",background:"background",connect:"connect",connects:"connects",ltr:"ltr",rtl:"rtl",textDirectionLtr:"txt-dir-ltr",textDirectionRtl:"txt-dir-rtl",draggable:"draggable",drag:"state-drag",tap:"state-tap",active:"active",tooltip:"tooltip",pips:"pips",pipsHorizontal:"pips-horizontal",pipsVertical:"pips-vertical",marker:"marker",markerHorizontal:"marker-horizontal",markerVertical:"marker-vertical",markerNormal:"marker-normal",markerLarge:"marker-large",markerSub:"marker-sub",value:"value",valueHorizontal:"value-horizontal",valueVertical:"value-vertical",valueNormal:"value-normal",valueLarge:"value-large",valueSub:"value-sub"},le={tooltips:".__tooltips",aria:".__aria"};function de(e,t){if(!Z(t))throw new Error("noUiSlider: 'step' is not numeric.");e.singleStep=t}function ce(e,t){if(!Z(t))throw new Error("noUiSlider: 'keyboardPageMultiplier' is not numeric.");e.keyboardPageMultiplier=t}function ue(e,t){if(!Z(t))throw new Error("noUiSlider: 'keyboardMultiplier' is not numeric.");e.keyboardMultiplier=t}function he(e,t){if(!Z(t))throw new Error("noUiSlider: 'keyboardDefaultStep' is not numeric.");e.keyboardDefaultStep=t}function me(e,t){if("object"!=typeof t||Array.isArray(t))throw new Error("noUiSlider: 'range' is not an object.");if(void 0===t.min||void 0===t.max)throw new Error("noUiSlider: Missing 'min' or 'max' in 'range'.");e.spectrum=new re(t,e.snap||!1,e.singleStep)}function pe(e,t){if(t=Y(t),!Array.isArray(t)||!t.length)throw new Error("noUiSlider: 'start' option is incorrect.");e.handles=t.length,e.start=t}function ge(e,t){if("boolean"!=typeof t)throw new Error("noUiSlider: 'snap' option must be a boolean.");e.snap=t}function fe(e,t){if("boolean"!=typeof t)throw new Error("noUiSlider: 'animate' option must be a boolean.");e.animate=t}function ve(e,t){if("number"!=typeof t)throw new Error("noUiSlider: 'animationDuration' option must be a number.");e.animationDuration=t}function we(e,t){var i,n=[!1];if("lower"===t?t=[!0,!1]:"upper"===t&&(t=[!1,!0]),!0===t||!1===t){for(i=1;i<e.handles;i++)n.push(t);n.push(!1)}else{if(!Array.isArray(t)||!t.length||t.length!==e.handles+1)throw new Error("noUiSlider: 'connect' option doesn't match handle count.");n=t}e.connect=n}function be(e,t){switch(t){case"horizontal":e.ort=0;break;case"vertical":e.ort=1;break;default:throw new Error("noUiSlider: 'orientation' option is invalid.")}}function ye(e,t){if(!Z(t))throw new Error("noUiSlider: 'margin' option must be numeric.");0!==t&&(e.margin=e.spectrum.getDistance(t))}function Se(e,t){if(!Z(t))throw new Error("noUiSlider: 'limit' option must be numeric.");if(e.limit=e.spectrum.getDistance(t),!e.limit||e.handles<2)throw new Error("noUiSlider: 'limit' option is only supported on linear sliders with 2 or more handles.")}function _e(e,t){var i;if(!Z(t)&&!Array.isArray(t))throw new Error("noUiSlider: 'padding' option must be numeric or array of exactly 2 numbers.");if(Array.isArray(t)&&2!==t.length&&!Z(t[0])&&!Z(t[1]))throw new Error("noUiSlider: 'padding' option must be numeric or array of exactly 2 numbers.");if(0!==t){for(Array.isArray(t)||(t=[t,t]),e.padding=[e.spectrum.getDistance(t[0]),e.spectrum.getDistance(t[1])],i=0;i<e.spectrum.xNumSteps.length-1;i++)if(e.padding[0][i]<0||e.padding[1][i]<0)throw new Error("noUiSlider: 'padding' option must be a positive number(s).");var n=t[0]+t[1],s=e.spectrum.xVal[0];if(n/(e.spectrum.xVal[e.spectrum.xVal.length-1]-s)>1)throw new Error("noUiSlider: 'padding' option must not exceed 100% of the range.")}}function Le(e,t){switch(t){case"ltr":e.dir=0;break;case"rtl":e.dir=1;break;default:throw new Error("noUiSlider: 'direction' option was not recognized.")}}function ke(e,t){if("string"!=typeof t)throw new Error("noUiSlider: 'behaviour' must be a string containing options.");var i=t.indexOf("tap")>=0,n=t.indexOf("drag")>=0,s=t.indexOf("fixed")>=0,r=t.indexOf("snap")>=0,a=t.indexOf("hover")>=0,o=t.indexOf("unconstrained")>=0,l=t.indexOf("invert-connects")>=0,d=t.indexOf("drag-all")>=0,c=t.indexOf("smooth-steps")>=0;if(s){if(2!==e.handles)throw new Error("noUiSlider: 'fixed' behaviour must be used with 2 handles");ye(e,e.start[1]-e.start[0])}if(l&&2!==e.handles)throw new Error("noUiSlider: 'invert-connects' behaviour must be used with 2 handles");if(o&&(e.margin||e.limit))throw new Error("noUiSlider: 'unconstrained' behaviour cannot be used with margin or limit");e.events={tap:i||r,drag:n,dragAll:d,smoothSteps:c,fixed:s,snap:r,hover:a,unconstrained:o,invertConnects:l}}function Ee(e,t){if(!1!==t)if(!0===t||z(t)){e.tooltips=[];for(var i=0;i<e.handles;i++)e.tooltips.push(t)}else{if((t=Y(t)).length!==e.handles)throw new Error("noUiSlider: must pass a formatter for all handles.");t.forEach((function(e){if("boolean"!=typeof e&&!z(e))throw new Error("noUiSlider: 'tooltips' must be passed a formatter or 'false'.")})),e.tooltips=t}}function Te(e,t){if(t.length!==e.handles)throw new Error("noUiSlider: must pass a attributes for all handles.");e.handleAttributes=t}function Ce(e,t){if(!z(t))throw new Error("noUiSlider: 'ariaFormat' requires 'to' method.");e.ariaFormat=t}function Ae(e,t){if(!function(e){return z(e)&&"function"==typeof e.from}(t))throw new Error("noUiSlider: 'format' requires 'to' and 'from' methods.");e.format=t}function xe(e,t){if("boolean"!=typeof t)throw new Error("noUiSlider: 'keyboardSupport' option must be a boolean.");e.keyboardSupport=t}function Ie(e,t){e.documentElement=t}function Me(e,t){if("string"!=typeof t&&!1!==t)throw new Error("noUiSlider: 'cssPrefix' must be a string or `false`.");e.cssPrefix=t}function Pe(e,t){if("object"!=typeof t)throw new Error("noUiSlider: 'cssClasses' must be an object.");"string"==typeof e.cssPrefix?(e.cssClasses={},Object.keys(t).forEach((function(i){e.cssClasses[i]=e.cssPrefix+t[i]}))):e.cssClasses=t}function qe(e){var t={margin:null,limit:null,padding:null,animate:!0,animationDuration:300,ariaFormat:ae,format:ae},i={step:{r:!1,t:de},keyboardPageMultiplier:{r:!1,t:ce},keyboardMultiplier:{r:!1,t:ue},keyboardDefaultStep:{r:!1,t:he},start:{r:!0,t:pe},connect:{r:!0,t:we},direction:{r:!0,t:Le},snap:{r:!1,t:ge},animate:{r:!1,t:fe},animationDuration:{r:!1,t:ve},range:{r:!0,t:me},orientation:{r:!1,t:be},margin:{r:!1,t:ye},limit:{r:!1,t:Se},padding:{r:!1,t:_e},behaviour:{r:!0,t:ke},ariaFormat:{r:!1,t:Ce},format:{r:!1,t:Ae},tooltips:{r:!1,t:Ee},keyboardSupport:{r:!0,t:xe},documentElement:{r:!1,t:Ie},cssPrefix:{r:!0,t:Me},cssClasses:{r:!0,t:Pe},handleAttributes:{r:!1,t:Te}},n={connect:!1,direction:"ltr",behaviour:"tap",orientation:"horizontal",keyboardSupport:!0,cssPrefix:"noUi-",cssClasses:oe,keyboardPageMultiplier:5,keyboardMultiplier:1,keyboardDefaultStep:10};e.format&&!e.ariaFormat&&(e.ariaFormat=e.format),Object.keys(i).forEach((function(s){if(G(e[s])||void 0!==n[s])i[s].t(t,G(e[s])?e[s]:n[s]);else if(i[s].r)throw new Error("noUiSlider: '"+s+"' is required.")})),t.pips=e.pips;var s=document.createElement("div"),r=void 0!==s.style.msTransform,a=void 0!==s.style.transform;return t.transformRule=a?"transform":r?"msTransform":"webkitTransform",t.style=[["left","top"],["right","bottom"]][t.dir][t.ort],t}function Be(e,t,i){var n,s,r,a,o,l,d,c=window.navigator.pointerEnabled?{start:"pointerdown",move:"pointermove",end:"pointerup"}:window.navigator.msPointerEnabled?{start:"MSPointerDown",move:"MSPointerMove",end:"MSPointerUp"}:{start:"mousedown touchstart",move:"mousemove touchmove",end:"mouseup touchend"},u=window.CSS&&CSS.supports&&CSS.supports("touch-action","none")&&function(){var e=!1;try{var t=Object.defineProperty({},"passive",{get:function(){e=!0}});window.addEventListener("test",null,t)}catch(e){}return e}(),h=e,m=t.spectrum,p=[],g=[],f=[],v=0,w={},b=!1,y=e.ownerDocument,S=t.documentElement||y.documentElement,_=y.body,L="rtl"===y.dir||1===t.ort?0:100;function k(e,t){var i=y.createElement("div");return t&&Q(i,t),e.appendChild(i),i}function E(e,i){var n=k(e,t.cssClasses.origin),s=k(n,t.cssClasses.handle);if(k(s,t.cssClasses.touchArea),s.setAttribute("data-handle",String(i)),t.keyboardSupport&&(s.setAttribute("tabindex","0"),s.addEventListener("keydown",(function(e){return function(e,i){if(A()||x(i))return!1;var n=["Left","Right"],s=["Down","Up"],r=["PageDown","PageUp"],a=["Home","End"];t.dir&&!t.ort?n.reverse():t.ort&&!t.dir&&(s.reverse(),r.reverse());var o,l=e.key.replace("Arrow",""),d=l===r[0],c=l===r[1],u=l===s[0]||l===n[0]||d,h=l===s[1]||l===n[1]||c,f=l===a[1];if(!(u||h||l===a[0]||f))return!0;if(e.preventDefault(),h||u){var v=u?0:1,w=fe(i)[v];if(null===w)return!1;!1===w&&(w=m.getDefaultStep(g[i],u,t.keyboardDefaultStep)),w*=c||d?t.keyboardPageMultiplier:t.keyboardMultiplier,w=Math.max(w,1e-7),w*=u?-1:1,o=p[i]+w}else o=f?t.spectrum.xVal[t.spectrum.xVal.length-1]:t.spectrum.xVal[0];return ue(i,m.toStepping(o),!0,!0),se("slide",i),se("update",i),se("change",i),se("set",i),!1}(e,i)}))),void 0!==t.handleAttributes){var r=t.handleAttributes[i];Object.keys(r).forEach((function(e){s.setAttribute(e,r[e])}))}return s.setAttribute("role","slider"),s.setAttribute("aria-orientation",t.ort?"vertical":"horizontal"),0===i?Q(s,t.cssClasses.handleLower):i===t.handles-1&&Q(s,t.cssClasses.handleUpper),n.handle=s,n}function T(e,i){return!!i&&k(e,t.cssClasses.connect)}function C(e,i){return!(!t.tooltips||!t.tooltips[i])&&k(e.firstChild,t.cssClasses.tooltip)}function A(){return h.hasAttribute("disabled")}function x(e){return r[e].hasAttribute("disabled")}function I(){l&&(ne("update"+le.tooltips),l.forEach((function(e){e&&j(e)})),l=null)}function M(){I(),l=r.map(C),ie("update"+le.tooltips,(function(e,i,n){if(l&&t.tooltips&&!1!==l[i]){var s=e[i];!0!==t.tooltips[i]&&(s=t.tooltips[i].to(n[i])),l[i].innerHTML=s}}))}function P(e,t){return e.map((function(e){return m.fromStepping(t?m.getStep(e):e)}))}function q(){o&&(j(o),o=null)}function B(e){q();var i=function(e){var t,i=function(e){if(e.mode===H.Range||e.mode===H.Steps)return m.xVal;if(e.mode===H.Count){if(e.values<2)throw new Error("noUiSlider: 'values' (>= 2) required for mode 'count'.");for(var t=e.values-1,i=100/t,n=[];t--;)n[t]=t*i;return n.push(100),P(n,e.stepped)}return e.mode===H.Positions?P(e.values,e.stepped):e.mode===H.Values?e.stepped?e.values.map((function(e){return m.fromStepping(m.getStep(m.toStepping(e)))})):e.values:[]}(e),n={},s=m.xVal[0],r=m.xVal[m.xVal.length-1],a=!1,o=!1,l=0;return t=i.slice().sort((function(e,t){return e-t})),(i=t.filter((function(e){return!this[e]&&(this[e]=!0)}),{}))[0]!==s&&(i.unshift(s),a=!0),i[i.length-1]!==r&&(i.push(r),o=!0),i.forEach((function(t,s){var r,d,c,u,h,p,g,f,v,w,b=t,y=i[s+1],S=e.mode===H.Steps;for(S&&(r=m.xNumSteps[s]),r||(r=y-b),void 0===y&&(y=b),r=Math.max(r,1e-7),d=b;d<=y;d=Number((d+r).toFixed(7))){for(f=(h=(u=m.toStepping(d))-l)/(e.density||1),w=h/(v=Math.round(f)),c=1;c<=v;c+=1)n[(p=l+c*w).toFixed(5)]=[m.fromStepping(p),0];g=i.indexOf(d)>-1?O.LargeValue:S?O.SmallValue:O.NoValue,!s&&a&&d!==y&&(g=0),d===y&&o||(n[u.toFixed(5)]=[d,g]),l=u}})),n}(e),n=e.filter,s=e.format||{to:function(e){return String(Math.round(e))}};return o=h.appendChild(function(e,i,n){var s,r,a=y.createElement("div"),o=((s={})[O.None]="",s[O.NoValue]=t.cssClasses.valueNormal,s[O.LargeValue]=t.cssClasses.valueLarge,s[O.SmallValue]=t.cssClasses.valueSub,s),l=((r={})[O.None]="",r[O.NoValue]=t.cssClasses.markerNormal,r[O.LargeValue]=t.cssClasses.markerLarge,r[O.SmallValue]=t.cssClasses.markerSub,r),d=[t.cssClasses.valueHorizontal,t.cssClasses.valueVertical],c=[t.cssClasses.markerHorizontal,t.cssClasses.markerVertical];function u(e,i){var n=i===t.cssClasses.value,s=n?o:l;return i+" "+(n?d:c)[t.ort]+" "+s[e]}return Q(a,t.cssClasses.pips),Q(a,0===t.ort?t.cssClasses.pipsHorizontal:t.cssClasses.pipsVertical),Object.keys(e).forEach((function(s){!function(e,s,r){if((r=i?i(s,r):r)!==O.None){var o=k(a,!1);o.className=u(r,t.cssClasses.marker),o.style[t.style]=e+"%",r>O.NoValue&&((o=k(a,!1)).className=u(r,t.cssClasses.value),o.setAttribute("data-value",String(s)),o.style[t.style]=e+"%",o.innerHTML=String(n.to(s)))}}(s,e[s][0],e[s][1])})),a}(i,n,s))}function F(){var e=n.getBoundingClientRect(),i="offset"+["Width","Height"][t.ort];return 0===t.ort?e.width||n[i]:e.height||n[i]}function N(e,i,n,s){var r=function(r){var a,o,l=function(e,t,i){var n=0===e.type.indexOf("touch"),s=0===e.type.indexOf("mouse"),r=0===e.type.indexOf("pointer"),a=0,o=0;if(0===e.type.indexOf("MSPointer")&&(r=!0),"mousedown"===e.type&&!e.buttons&&!e.touches)return!1;if(n){var l=function(t){var n=t.target;return n===i||i.contains(n)||e.composed&&e.composedPath().shift()===i};if("touchstart"===e.type){var d=Array.prototype.filter.call(e.touches,l);if(d.length>1)return!1;a=d[0].pageX,o=d[0].pageY}else{var c=Array.prototype.find.call(e.changedTouches,l);if(!c)return!1;a=c.pageX,o=c.pageY}}return t=t||te(y),(s||r)&&(a=e.clientX+t.x,o=e.clientY+t.y),e.pageOffset=t,e.points=[a,o],e.cursor=s||r,e}(r,s.pageOffset,s.target||i);return!!l&&!(A()&&!s.doNotReject)&&(a=h,o=t.cssClasses.tap,!((a.classList?a.classList.contains(o):new RegExp("\\b"+o+"\\b").test(a.className))&&!s.doNotReject)&&!(e===c.start&&void 0!==l.buttons&&l.buttons>1)&&(!s.hover||!l.buttons)&&(u||l.preventDefault(),l.calcPoint=l.points[t.ort],void n(l,s)))},a=[];return e.split(" ").forEach((function(e){i.addEventListener(e,r,!!u&&{passive:!0}),a.push([e,r])})),a}function R(e){var i,s,r,a,o,l,d=100*(e-(i=n,s=t.ort,r=i.getBoundingClientRect(),o=(a=i.ownerDocument).documentElement,l=te(a),/webkit.*Chrome.*Mobile/i.test(navigator.userAgent)&&(l.x=0),s?r.top+l.y-o.clientTop:r.left+l.x-o.clientLeft))/F();return d=J(d),t.dir?100-d:d}function U(e,t){"mouseout"===e.type&&"HTML"===e.target.nodeName&&null===e.relatedTarget&&$(e,t)}function D(e,i){if(-1===navigator.appVersion.indexOf("MSIE 9")&&0===e.buttons&&0!==i.buttonsProperty)return $(e,i);var n=(t.dir?-1:1)*(e.calcPoint-i.startCalcPoint);oe(n>0,100*n/i.baseSize,i.locations,i.handleNumbers,i.connect)}function $(e,i){i.handle&&(ee(i.handle,t.cssClasses.active),v-=1),i.listeners.forEach((function(e){S.removeEventListener(e[0],e[1])})),0===v&&(ee(h,t.cssClasses.drag),ce(),e.cursor&&(_.style.cursor="",_.removeEventListener("selectstart",W))),t.events.smoothSteps&&(i.handleNumbers.forEach((function(e){ue(e,g[e],!0,!0,!1,!1)})),i.handleNumbers.forEach((function(e){se("update",e)}))),i.handleNumbers.forEach((function(e){se("change",e),se("set",e),se("end",e)}))}function V(e,i){if(!i.handleNumbers.some(x)){var n;1===i.handleNumbers.length&&(n=r[i.handleNumbers[0]].children[0],v+=1,Q(n,t.cssClasses.active)),e.stopPropagation();var s=[],a=N(c.move,S,D,{target:e.target,handle:n,connect:i.connect,listeners:s,startCalcPoint:e.calcPoint,baseSize:F(),pageOffset:e.pageOffset,handleNumbers:i.handleNumbers,buttonsProperty:e.buttons,locations:g.slice()}),o=N(c.end,S,$,{target:e.target,handle:n,listeners:s,doNotReject:!0,handleNumbers:i.handleNumbers}),l=N("mouseout",S,U,{target:e.target,handle:n,listeners:s,doNotReject:!0,handleNumbers:i.handleNumbers});s.push.apply(s,a.concat(o,l)),e.cursor&&(_.style.cursor=getComputedStyle(e.target).cursor,r.length>1&&Q(h,t.cssClasses.drag),_.addEventListener("selectstart",W,!1)),i.handleNumbers.forEach((function(e){se("start",e)}))}}function z(e){e.stopPropagation();var i=R(e.calcPoint),n=function(e){var t=100,i=!1;return r.forEach((function(n,s){if(!x(s)){var r=g[s],a=Math.abs(r-e);(a<t||a<=t&&e>r||100===a&&100===t)&&(i=s,t=a)}})),i}(i);!1!==n&&(t.events.snap||X(h,t.cssClasses.tap,t.animationDuration),ue(n,i,!0,!0),ce(),se("slide",n,!0),se("update",n,!0),t.events.snap?V(e,{handleNumbers:[n]}):(se("change",n,!0),se("set",n,!0)))}function Z(e){var t=R(e.calcPoint),i=m.getStep(t),n=m.fromStepping(i);Object.keys(w).forEach((function(e){"hover"===e.split(".")[0]&&w[e].forEach((function(e){e.call(be,n)}))}))}function K(e){e.fixed||r.forEach((function(e,t){N(c.start,e.children[0],V,{handleNumbers:[t]})})),e.tap&&N(c.start,n,z,{}),e.hover&&N(c.move,n,Z,{hover:!0}),e.drag&&a.forEach((function(i,n){if(!1!==i&&0!==n&&n!==a.length-1){var s=r[n-1],o=r[n],l=[i],d=[s,o],u=[n-1,n];Q(i,t.cssClasses.draggable),e.fixed&&(l.push(s.children[0]),l.push(o.children[0])),e.dragAll&&(d=r,u=f),l.forEach((function(e){N(c.start,e,V,{handles:d,handleNumbers:u,connect:i})}))}}))}function ie(e,t){w[e]=w[e]||[],w[e].push(t),"update"===e.split(".")[0]&&r.forEach((function(e,t){se("update",t)}))}function ne(e){var t=e&&e.split(".")[0],i=t?e.substring(t.length):e;Object.keys(w).forEach((function(e){var n=e.split(".")[0],s=e.substring(n.length);t&&t!==n||i&&i!==s||function(e){return e===le.aria||e===le.tooltips}(s)&&i!==s||delete w[e]}))}function se(e,i,n){Object.keys(w).forEach((function(s){var r=s.split(".")[0];e===r&&w[s].forEach((function(e){e.call(be,p.map(t.format.to),i,p.slice(),n||!1,g.slice(),be)}))}))}function re(e,i,n,s,a,o,l){var d;return r.length>1&&!t.events.unconstrained&&(s&&i>0&&(d=m.getAbsoluteDistance(e[i-1],t.margin,!1),n=Math.max(n,d)),a&&i<r.length-1&&(d=m.getAbsoluteDistance(e[i+1],t.margin,!0),n=Math.min(n,d))),r.length>1&&t.limit&&(s&&i>0&&(d=m.getAbsoluteDistance(e[i-1],t.limit,!1),n=Math.min(n,d)),a&&i<r.length-1&&(d=m.getAbsoluteDistance(e[i+1],t.limit,!0),n=Math.max(n,d))),t.padding&&(0===i&&(d=m.getAbsoluteDistance(0,t.padding[0],!1),n=Math.max(n,d)),i===r.length-1&&(d=m.getAbsoluteDistance(100,t.padding[1],!0),n=Math.min(n,d))),l||(n=m.getStep(n)),!((n=J(n))===e[i]&&!o)&&n}function ae(e,i){var n=t.ort;return(n?i:e)+", "+(n?e:i)}function oe(e,i,n,s,r){var a=n.slice(),o=s[0],l=t.events.smoothSteps,d=[!e,e],c=[e,!e];s=s.slice(),e&&s.reverse(),s.length>1?s.forEach((function(e,t){var n=re(a,e,a[e]+i,d[t],c[t],!1,l);!1===n?i=0:(i=n-a[e],a[e]=n)})):d=c=[!0];var u=!1;s.forEach((function(e,t){u=ue(e,n[e]+i,d[t],c[t],!1,l)||u})),u&&(s.forEach((function(e){se("update",e),se("slide",e)})),null!=r&&se("drag",o))}function de(e,i){return t.dir?100-e-i:e}function ce(){f.forEach((function(e){var t=g[e]>50?-1:1,i=3+(r.length+t*e);r[e].style.zIndex=String(i)}))}function ue(e,i,n,s,a,o){return a||(i=re(g,e,i,n,s,!1,o)),!1!==i&&(function(e,i){g[e]=i,p[e]=m.fromStepping(i);var n="translate("+ae(de(i,0)-L+"%","0")+")";if(r[e].style[t.transformRule]=n,t.events.invertConnects&&g.length>1){var s=g.every((function(e,t,i){return 0===t||e>=i[t-1]}));if(b!==!s)return b=!b,we(t,t.connect.map((function(e){return!e}))),void ve()}he(e),he(e+1),b&&(he(e-1),he(e+2))}(e,i),!0)}function he(e){if(a[e]){var i=g.slice();b&&i.sort((function(e,t){return e-t}));var n=0,s=100;0!==e&&(n=i[e-1]),e!==a.length-1&&(s=i[e]);var r=s-n,o="translate("+ae(de(n,r)+"%","0")+")",l="scale("+ae(r/100,"1")+")";a[e].style[t.transformRule]=o+" "+l}}function me(e,i){return null===e||!1===e||void 0===e?g[i]:("number"==typeof e&&(e=String(e)),!1!==(e=t.format.from(e))&&(e=m.toStepping(e)),!1===e||isNaN(e)?g[i]:e)}function pe(e,i,n){var s=Y(e),r=void 0===g[0];i=void 0===i||i,t.animate&&!r&&X(h,t.cssClasses.tap,t.animationDuration),f.forEach((function(e){ue(e,me(s[e],e),!0,!1,n)}));var a=1===f.length?0:1;if(r&&m.hasNoSize()&&(n=!0,g[0]=0,f.length>1)){var o=100/(f.length-1);f.forEach((function(e){g[e]=e*o}))}for(;a<f.length;++a)f.forEach((function(e){ue(e,g[e],!0,!0,n)}));ce(),f.forEach((function(e){se("update",e),null!==s[e]&&i&&se("set",e)}))}function ge(e){if(void 0===e&&(e=!1),e)return 1===p.length?p[0]:p.slice(0);var i=p.map(t.format.to);return 1===i.length?i[0]:i}function fe(e){var i=g[e],n=m.getNearbySteps(i),s=p[e],r=n.thisStep.step,a=null;if(t.snap)return[s-n.stepBefore.startValue||null,n.stepAfter.startValue-s||null];!1!==r&&s+r>n.stepAfter.startValue&&(r=n.stepAfter.startValue-s),a=s>n.thisStep.startValue?n.thisStep.step:!1!==n.stepBefore.step&&s-n.stepBefore.highestStep,100===i?r=null:0===i&&(a=null);var o=m.countStepDecimals();return null!==r&&!1!==r&&(r=Number(r.toFixed(o))),null!==a&&!1!==a&&(a=Number(a.toFixed(o))),[a,r]}function ve(){for(;s.firstChild;)s.removeChild(s.firstChild);for(var e=0;e<=t.handles;e++)a[e]=T(s,t.connect[e]),he(e);K({drag:t.events.drag,fixed:!0})}Q(d=h,t.cssClasses.target),0===t.dir?Q(d,t.cssClasses.ltr):Q(d,t.cssClasses.rtl),0===t.ort?Q(d,t.cssClasses.horizontal):Q(d,t.cssClasses.vertical),Q(d,"rtl"===getComputedStyle(d).direction?t.cssClasses.textDirectionRtl:t.cssClasses.textDirectionLtr),n=k(d,t.cssClasses.base),function(e,i){s=k(i,t.cssClasses.connects),r=[],(a=[]).push(T(s,e[0]));for(var n=0;n<t.handles;n++)r.push(E(i,n)),f[n]=n,a.push(T(s,e[n+1]))}(t.connect,n),K(t.events),pe(t.start),t.pips&&B(t.pips),t.tooltips&&M(),ne("update"+le.aria),ie("update"+le.aria,(function(e,i,n,s,a){f.forEach((function(e){var i=r[e],s=re(g,e,0,!0,!0,!0),o=re(g,e,100,!0,!0,!0),l=a[e],d=String(t.ariaFormat.to(n[e]));s=m.fromStepping(s).toFixed(1),o=m.fromStepping(o).toFixed(1),l=m.fromStepping(l).toFixed(1),i.children[0].setAttribute("aria-valuemin",s),i.children[0].setAttribute("aria-valuemax",o),i.children[0].setAttribute("aria-valuenow",l),i.children[0].setAttribute("aria-valuetext",d)}))}));var be={destroy:function(){for(ne(le.aria),ne(le.tooltips),Object.keys(t.cssClasses).forEach((function(e){ee(h,t.cssClasses[e])}));h.firstChild;)h.removeChild(h.firstChild);delete h.noUiSlider},steps:function(){return f.map(fe)},on:ie,off:ne,get:ge,set:pe,setHandle:function(e,t,i,n){if(!((e=Number(e))>=0&&e<f.length))throw new Error("noUiSlider: invalid handle number, got: "+e);ue(e,me(t,e),!0,!0,n),se("update",e),i&&se("set",e)},reset:function(e){pe(t.start,e)},disable:function(e){null!=e?(r[e].setAttribute("disabled",""),r[e].handle.removeAttribute("tabindex")):(h.setAttribute("disabled",""),r.forEach((function(e){e.handle.removeAttribute("tabindex")})))},enable:function(e){null!=e?(r[e].removeAttribute("disabled"),r[e].handle.setAttribute("tabindex","0")):(h.removeAttribute("disabled"),r.forEach((function(e){e.removeAttribute("disabled"),e.handle.setAttribute("tabindex","0")})))},__moveHandles:function(e,t,i){oe(e,t,g,i)},options:i,updateOptions:function(e,n){var s=ge(),r=["margin","limit","padding","range","animate","snap","step","format","pips","tooltips","connect"];r.forEach((function(t){void 0!==e[t]&&(i[t]=e[t])}));var a=qe(i);r.forEach((function(i){void 0!==e[i]&&(t[i]=a[i])})),m=a.spectrum,t.margin=a.margin,t.limit=a.limit,t.padding=a.padding,t.pips?B(t.pips):q(),t.tooltips?M():I(),g=[],pe(G(e.start)?e.start:s,n),e.connect&&ve()},target:h,removePips:q,removeTooltips:I,getPositions:function(){return g.slice()},getTooltips:function(){return l},getOrigins:function(){return r},pips:B};return be}var Fe=i(865),Ne=i(25),Re=i(809);class Ue{static _instance=null;static getOrCreateInstance(){return Ue._instance||(Ue._instance=new Ue),Ue._instance}constructor(){this.postId=null;let e=D.A.render('<div class="modal fade" id="deleteDraftModal" tabindex="-1" aria-modal="true" role="dialog" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h1 class="modal-title fs-5" data-l10n-key="delete-draft-popup.title"></h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body" data-l10n-key="delete-draft-popup.desc"></div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-l10n-key="button_close"></button> <button type="submit" class="btn btn-danger" id="deleteDraftModalBtnDelete" data-l10n-key="button_delete"></button> </div> </div> </div> </div>');document.body.appendChild(e),this.node=e,this.bsModal=u.Modal.getOrCreateInstance(e),this.nodes={btnDelete:e.querySelector("#deleteDraftModalBtnDelete")},this.nodes.btnDelete.addEventListener("click",(()=>{this._send()}))}open(e){e&&(this.postId=e,this.bsModal.show())}_isSending=!1;_send(){if(!this.postId)return;if(this._isSending)return;this._isSending=!0;let e=this.nodes.btnDelete.innerText;this.nodes.btnDelete.innerHTML=a.A,this.nodes.btnDelete.disabled=!0;var t=new FormData;t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t.append("postId",this.postId),(0,s.A)("/api/deleteDraft",{method:"POST",credentials:"include",body:t}).then((e=>{if(e?.success){let e=document.querySelector(`.feed__item[data-feed-pid="${this.postId}"]`);e?e.remove():window.location.href="/"}else window.app.error(e.message)})).finally((()=>{this.nodes.btnDelete.innerText=e,this.nodes.btnDelete.disabled=!1,this._isSending=!1,this.bsModal.hide()}))}}class He{static _instance=null;static getOrCreateInstance(){return He._instance||(He._instance=new He),He._instance}constructor(){let e=D.A.render('<div class="modal fade" id="commentRuleModal" tabindex="-1" aria-modal="true" role="dialog" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h1 class="modal-title fs-5" data-l10n-key="comment-rule-popup.title"></h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <p class="mb-2 fw-bold" data-l10n-key="comment-rule-popup.row-1"></p> <p class="mb-2" data-l10n-key="comment-rule-popup.row-2"></p> <table class="ms-1 mb-2 border-0"> <tr> <td class="text-success" style="font-size:1.25em;vertical-align:top"><i class="bi bi-check-circle-fill me-3"></i></td> <td class="pb-1" data-l10n-key="comment-rule-popup.row-3"></td> </tr> <tr> <td class="text-success" style="font-size:1.25em;vertical-align:top"><i class="bi bi-check-circle-fill me-3"></i></td> <td class="pb-1" data-l10n-key="comment-rule-popup.row-4"></td> </tr> <tr> <td class="text-danger" style="font-size:1.25em;vertical-align:top"><i class="bi bi-x-circle-fill me-3"></i></td> <td data-l10n-key="comment-rule-popup.row-5"></td> </tr> </table> <p class="mb-2" data-l10n-key="comment-rule-popup.row-6"></p> <a href="#" target="_blank" data-l10n-key="comment-rule-popup.link"></a> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-l10n-key="button_close"></button> </div> </div> </div> </div>');document.body.appendChild(e),this.node=e,this.bsModal=u.Modal.getOrCreateInstance(e)}open(){this.bsModal.show()}}var Oe=i(59),De=i(649),$e=i(503);class Ve{static init(){const e=document.querySelectorAll(".info-block-place");Ve._fillInfoBlocks(e),window.addEventListener("resize",(function(){Ve._fillInfoBlocks(e)}))}static _fillInfoBlocks(e){let t=[];e.forEach((e=>{e.classList.contains("js-loaded")||"none"!==window.getComputedStyle(e,null).display&&t.push(e)}));let i=[];if(t.forEach((e=>{i.push({placeId:e.getAttribute("data-place-id"),tags:e.getAttribute("data-place-tags")})})),0===i.length)return;const n=new FormData;n.append(window.app.getCSRFParam(),window.app.getCSRFToken()),n.append("json",JSON.stringify(i)),(0,s.A)("/api/getInfoBlocks",{method:"POST",credentials:"include",body:n}).finally((e=>{t.forEach((e=>{e.classList.add("js-loaded"),e.innerHTML=""}))})).then((e=>{e?.success?(e.data||[]).forEach((e=>{const i=e.placeId,n=t.find((e=>e.getAttribute("data-place-id")===i));if(n){const t=e.nodes.join("");n.innerHTML=t}})):window.app.error(e.message)}))}}var ze={main:class{constructor(){var e=document.getElementById("feed");null!==e&&(this.feed=l.init(e)),this.swiper=null,window.addEventListener("resize",(()=>{this._updateMainButtons()})),this._updateMainButtons()}_updateMainButtons(){let e=parseInt(window.getComputedStyle(document.body).getPropertyValue("--bs-breakpoint-sm"));window.innerWidth<e?this.swiper?this.swiper.enable():window.app.loadModule("swiper").then((({default:e})=>{this.swiper=new e.Swiper(".main-button.swiper",{slidesPerView:"auto",spaceBetween:8,centeredSlides:!0,loop:!0,autoplay:{delay:3e3,disableOnInteraction:!1},pagination:{el:".swiper-pagination",clickable:!0}})})):this.swiper&&this.swiper.disable()}},category:class{constructor(){this.categoryCard=document.querySelector(".category-card"),this.categoryId=Number(this.categoryCard.getAttribute("data-category-id"));let e=document.getElementById("feed");null!==e&&(this.feed=l.init(e)),this.categoryCard.querySelector(".tag-subscribe")?.addEventListener("click",(()=>{this.subscribe(0)})),this.categoryCard.querySelector(".tag-unsubscribe")?.addEventListener("click",(()=>{this.subscribe(-1)})),this.categoryCard.querySelector(".tag-ignore")?.addEventListener("click",(()=>{this.subscribe(1)})),this.categoryCard.querySelector(".tag-unignore")?.addEventListener("click",(()=>{this.subscribe(-1)}))}_inProcess=!1;async subscribe(e){if(!this._inProcess){if(null!==window.app.getLoginUser()){this._inProcess=!0;var t=new FormData;return t.append("category_id",this.categoryId),t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t.append("type",e),(0,s.A)("/api/categorySubscribe",{method:"POST",credentials:"include",body:t}).then((e=>{if(e.success)switch(this.categoryCard.classList.remove("subscribed"),this.categoryCard.classList.remove("ignored"),e.data.subscribe){case 0:this.categoryCard.classList.add("subscribed");break;case 1:this.categoryCard.classList.add("ignored")}else window.app.error(e.message)})).finally((()=>{this._inProcess=!1}))}window.app.info(window.app.l10n("unauthorized-error.subscribe"))}}},page:class{constructor(){d.init()}},post:class{constructor(){d.init();var e=document.getElementById("post");if(this.post_root=e,this.post_id=Number(e.getAttribute("data-post-id")),null!==window.app.getLoginUser()&&(this.voteManager=new c(this.post_id),this.bookmarkManager=new r(this.post_id)),null!==e.querySelector(".post-vote")){var t=this.post_root.querySelector(".post-vote");t.querySelector(".post-vote__button-minus").addEventListener("click",(()=>{this.post_root.classList.contains("post--voted-minus")?this.vote(null):this.vote(!1)})),t.querySelector(".post-vote__button-plus").addEventListener("click",(()=>{this.post_root.classList.contains("post--voted-plus")?this.vote(null):this.vote(!0)}))}e.querySelectorAll(".post-bookmark").forEach((t=>{t.addEventListener("click",(()=>{e.classList.contains("post--with-bookmark")?this.bookmark(!1):this.bookmark(!0)}))})),e.querySelectorAll(".post-share").forEach((e=>{navigator.share?e.addEventListener("click",(()=>{navigator.share({url:window.location.href,title:document.title})})):e.style.display="none"}));var i=document.getElementById("comments");i&&(this.comments=new p(this.post_id,i));let n=document.getElementById("modal-report-typo");if(n){let t=n.querySelector("pre"),i=n.querySelector("textarea"),r=n.querySelector("#modalBtnSendReportTypo"),o=u.Modal.getOrCreateInstance(n);document.addEventListener("keydown",(n=>{if((n.ctrlKey||n.metaKey)&&"Enter"===n.key){let n=document.getSelection();if(!n||n.isCollapsed||!e.contains(n.anchorNode))return;let s=n.toString().trim().slice(0,500);if(0===s.length)return;i.value="",t.innerText=s,o.show()}}));let l=!1;r.addEventListener("click",(()=>{if(l)return;let e=t.innerText.trim();if(0===e.length)return void window.app.error(window.app.l10n("report-popup.error-empty-fragment"));let n=i.value.trim();var d=new FormData;d.append(window.app.getCSRFParam(),window.app.getCSRFToken()),d.append("post_id",this.post_id),d.append("fragment",e),0!==n.length&&d.append("comment",n),l=!0;let c=r.innerText;r.disabled=!0,r.innerHTML=a.A,(0,s.A)("/api/reportTypo",{method:"POST",credentials:"include",body:d}).then((e=>{e.success?(window.app.success(window.app.l10n("report-popup.send")),o.hide()):window.app.error(e.message)})).finally((e=>{l=!1,r.innerText=c,r.disabled=!1}))}))}let o=document.getElementById("post_feed");if(o){this.feed=l.init(o);let e=document.getElementById("post_feed-nav");e&&e.addEventListener("click",(t=>{let i=t.target.closest("[data-feed-sort]");if(i){let t=i.getAttribute("data-feed-sort");this.feed.atributes.sort=t,e.querySelectorAll(".active[data-feed-sort]").forEach((e=>{e.classList.remove("active")})),i.classList.add("active"),this.feed.refresh()}}))}}voteSend=!1;vote(e){this.voteSend||(null!==window.app.getLoginUser()?(this.voteSend=!0,this.voteManager.vote(e).then((e=>{var t=this.post_root.querySelector(".post-vote"),i=t.querySelector(".post-vote__value");switch(this.post_root.classList.remove("post--voted-plus"),this.post_root.classList.remove("post--voted-minus"),e.data.vote){case 1:this.post_root.classList.add("post--voted-plus");break;case-1:this.post_root.classList.add("post--voted-minus")}t.classList.remove("post-vote--rating-positive"),t.classList.remove("post-vote--rating-negative");var n=window.app.getLang();i&&(0!==e.data.rating?(t.classList.add("post-vote--rating-positive"),i.innerText=new Intl.NumberFormat(n).format(e.data.rating),e.data.rating<0&&(i.innerText="+"+i.innerText)):i.innerText="—"),this.voteSend=!1})).catch((e=>{window.app.error(e.message),this.voteSend=!1}))):window.app.info(window.app.l10n("unauthorized-error.vote")))}bookmarkSend=!1;bookmark(e){this.bookmarkSend||(null!==window.app.getLoginUser()?(this.bookmarkSend=!0,this.bookmarkManager.bookmark(e).then((e=>{this.post_root.classList.toggle("post--with-bookmark",e.data.bookmark);var t=window.app.getLang();this.post_root.querySelectorAll(".post-bookmark .value").forEach((i=>{i.innerText=new Intl.NumberFormat(t).format(e.data.count)})),this.bookmarkSend=!1})).catch((e=>{window.app.error(e.message),this.bookmarkSend=!1}))):window.app.info(window.app.l10n("unauthorized-error.bookmark")))}},user:class{constructor(){var e=document.getElementById("user-profile");this.user_root=e,this.user_id=Number(e.getAttribute("data-user-id"));var t=document.getElementById("feed");null!==t&&(this.feed=l.init(t)),document.querySelector(".user-subscribe")?.addEventListener("click",(()=>{this.subscribe(0)})),document.querySelector(".user-unsubscribe")?.addEventListener("click",(()=>{this.subscribe(-1)})),document.querySelector(".user-ignore")?.addEventListener("click",(()=>{this.subscribe(1)})),document.querySelector(".user-unignore")?.addEventListener("click",(()=>{this.subscribe(-1)}))}_inProcess=!1;async subscribe(e){if(!this._inProcess){if(null!==window.app.getLoginUser()){this._inProcess=!0;var t=new FormData;return t.append("user_id",this.user_id),t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t.append("type",e),(0,s.A)("/api/userSubscribe",{method:"POST",credentials:"include",body:t}).then((e=>{if(e.success)switch(this.user_root.classList.remove("user-profile--subscribed"),this.user_root.classList.remove("user-profile--ignored"),e.data.subscribe){case 0:this.user_root.classList.add("user-profile--subscribed");break;case 1:this.user_root.classList.add("user-profile--ignored")}else window.app.error(e.message)})).finally((()=>{this._inProcess=!1}))}window.app.info(window.app.l10n("unauthorized-error.subscribe"))}}},"user-profile-setting":class{constructor(){var e=document.getElementById("user-profile__avatar-input");if(null!==e){var t=document.createElement("input");t.type="file",t.accept="image/png, image/jpeg, image/gif, image/webp",t.onchange=e=>{var t=e.target.files[0];this.uploadAvatar(t)},e.addEventListener("click",(()=>{t.click()}))}}uploadAvatar(e){var t=new FormData;return t.append("image_file",e),t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),(0,s.A)("/api/avatar",{method:"POST",credentials:"include",body:t}).then((e=>{e.success?document.querySelector(".user-profile__avatar img").src=e.data.url:window.app.error(e.message)}))}},editor:class{constructor(){var e=document.getElementById(b).value,t={};""!==e&&(t=JSON.parse(e)),this.timer=void 0,this.post_id=t.post_id||null,this.version_id=t.version_id||null,this.title_input=document.getElementById(y),this.title_input.value=t.title||null,this.title_input.oninput=()=>{this.autosave()};let i=t.source?JSON.parse(t.source):null;this.imageUploader=new g.A;let n="";if(0==this.title_input.value.trim().length&&null==i){let e=window.app.l10n("editor.random-placeholder");if(Array.isArray(e)&&e.length>0){let t=e[Math.floor(Math.random()*e.length)];this.title_input.setAttribute("placeholder",t[0]),n=t[1]}else n=window.app.l10n("editor.body-placeholder")}else n=window.app.l10n("editor.body-placeholder");let s=window.app.l10n("editorMessages");s||(s={}),window.app.loadModule("editor").then((async({default:e})=>{var t=async(e,t)=>{if(null===this.post_id&&await this.save("autosave"),"file"===t)return this.imageUploader.upload(e,`p_${this.post_id}`)};const r=await window.app.loadModule("sortable").then((({default:e})=>e.Sortable));this.editorjs=new e.EditorJS({holder:S,placeholder:n,onChange:()=>{this.autosave()},data:i,tools:{header:{class:e.Header,config:{levels:[2,3,4],defaultLevel:2}},list:{class:e.List,inlineToolbar:!0,config:{defaultStyle:"unordered"}},quote:{class:e.QuoteAdvanced,inlineToolbar:!0,config:{uploader:{uploadByFile:e=>t(e,"file")},types:"image/png, image/jpeg, image/gif, image/webp"}},image:{class:e.ImageTool,inlineToolbar:["link"],config:{uploader:{uploadByFile:e=>t(e,"file")},types:"image/png, image/jpeg, image/gif, image/webp",features:{border:!1}}},gallery:{class:e.ImageGallery,inlineToolbar:["link"],maxElementCount:9,config:{uploader:{uploadByFile:e=>t(e,"file")},types:"image/png, image/jpeg, image/gif, image/webp",sortableJs:r}},embed:{class:e.Embed,inlineToolbar:!0},table:{class:e.Table,inlineToolbar:!0,config:{rows:2,cols:3}},delimiter:e.Delimiter,spoiler:{class:e.Spoiler,config:{editorLibrary:e.EditorJS,editorTools:{header:{class:e.Header,config:{levels:[3,4],defaultLevel:3}},list:{class:e.List,inlineToolbar:!0,config:{defaultStyle:"unordered"}},quote:{class:e.QuoteAdvanced,inlineToolbar:!0,config:{uploader:{uploadByFile:e=>t(e,"file")},types:"image/png, image/jpeg, image/gif, image/webp"}},image:{class:e.ImageTool,inlineToolbar:["link"],config:{uploader:{uploadByFile:e=>t(e,"file")},types:"image/png, image/jpeg, image/gif, image/webp",features:{border:!1,stretch:!1}}},embed:{class:e.Embed,inlineToolbar:!0},table:{class:e.Table,inlineToolbar:!0,config:{rows:2,cols:3}},delimiter:e.Delimiter,code:e.CodeTool,anchorTune:e.AnchorTune,backgroundTune:e.BackgroundTune,marker:e.Marker,inlineCode:e.InlineCode,annotation:e.Annotation},editorTunes:["anchorTune","backgroundTune"]}},code:e.CodeTool,marker:e.Marker,inlineCode:e.InlineCode,annotation:e.Annotation,anchorTune:e.AnchorTune,backgroundTune:e.BackgroundTune},tunes:["anchorTune","backgroundTune"],i18n:{messages:s},onReady:()=>{document.getElementById("wiki-editor-preloader").classList.add("hide");const t=new e.Undo({editor:this.editorjs});null!==i&&t.initialize(i)}}),this.typograf=e.createTypograf(),this.btnTypograf=document.getElementById(C),this.btnTypograf.addEventListener("click",(()=>{this.runTypograf()}))}));let r=[];t.categories&&t.categories.forEach((e=>{r.push({value:e.tag,badgeHTML:e.title})})),this.categoriesSelector=(0,f.i)(document.getElementById(_),r,(()=>{this.autosave()}));let o=[];t.entities&&t.entities.forEach((e=>{let t=(0,v.Y)(e);null!==t&&o.push(t)})),this.entitiesSelector=(0,v.T)(document.getElementById(L),o,(()=>{this.autosave()})),document.addEventListener("click",(e=>{var t=e.target.closest("button");if(t)switch(t.id){case k:this.save("save");break;case E:this.save("preview");break;case M:this.openHistory()}}));let l=document.getElementById(q);if(l){let e=document.getElementById(T);if(e){e.addEventListener("click",(()=>{let t=e.innerText;e.innerHTML=a.A,e.disabled=!0,this.save("review").finally((i=>{e.innerText=t,e.disabled=!1}))}));let t=document.getElementById(B),i=document.getElementById(F),n=document.getElementById(N),s=document.getElementById(R);l.addEventListener("show.bs.modal",(()=>{let r=!1,a=!1,o=0,l=this.editorjs.blocks.getBlocksCount();for(let e=0;e<l;e++){let t=this.editorjs.blocks.getBlockByIndex(e);t&&!t.isEmpty&&(["image","gallery","embed"].includes(t.name)?a=!0:o+=t.holder.innerText.length)}o>500&&(r=!0);let d=this.categoriesSelector.getValues().length>0||this.entitiesSelector.getValues().length>0;if(r&&a&&d)t.classList.add("d-none"),e.classList.remove("d-none");else{t.classList.remove("d-none"),e.classList.add("d-none");let o=(e,t)=>{e.innerHTML=t?'<i class="bi bi-check-circle-fill text-success"></i>':'<i class="bi bi-x-circle-fill text-danger"></i>'};o(i,r),o(n,a),o(s,d)}}))}}}_saveInProgress=!1;async save(e){if(!this._saveInProgress){this._saveInProgress=!0;var t=await this.editorjs.save().then((e=>JSON.stringify(e))),i=this.categoriesSelector.getValues().join(";"),n=this.entitiesSelector.getValues().join(";"),r=document.getElementById(A),a=document.getElementById(x),o=document.getElementById(I),l=new FormData;switch(l.append(window.app.getCSRFParam(),window.app.getCSRFToken()),l.append("post_id",this.post_id||""),l.append("title",this.title_input.value.trim()||""),l.append("source",t||""),l.append("categories",i||""),l.append("entities",n||""),e){case"autosave":case"review":l.append("event",e);break;default:l.append("event","save")}return clearTimeout(this.timer),this.timer=void 0,r.classList.remove("d-none"),a.classList.add("d-none"),(0,s.A)("/api/save",{method:"POST",credentials:"include",body:l}).then((t=>{if(t.success){window.onbeforeunload=null,null===this.post_id&&(this.post_id=t.data.post_id,window.history.pushState({post_id:this.post_id},"",`/editor/${this.post_id}`));var i=new Date,n=i.getHours().toString().padStart(2,"0"),s=i.getMinutes().toString().padStart(2,"0");switch(o.innerText=`${n}:${s}`,a.classList.remove("d-none"),void 0!==t.data.version_id&&(this.version_id=t.data.version_id),e){case"preview":var r="/"+this.post_id;void 0!==t.data.version_id&&(r+="/"+t.data.version_id),window.open(r,"_blank").focus();break;case"review":if(!t.data.review){window.app.error(window.app.l10n("editor.error-create-ticket"));break}if(!t.data.review.success){window.app.error(t.data.review.message);break}window.location.href=`/u/tickets/${t.data.review.data.ticket_id}`}}else window.app.error(t.message)})).finally((e=>{r.classList.add("d-none"),this._saveInProgress=!1}))}}autosave(){void 0===this.timer&&(this.timer=setTimeout((()=>{this.save("autosave")}),3e5),window.onbeforeunload=()=>!0)}openHistory(){if(null!==this.post_id){var e=document.getElementById(P);if(null!==e){var t=u.Modal.getOrCreateInstance(e);t.show();var i=`${P}--empty`;if(e.classList.contains(i)){var n=new URL("/api/getPostHistory",window.location.origin);n.searchParams.set("post_id",this.post_id),(0,s.A)(n,{credentials:"include"}).then((t=>{var n=e.querySelector(".modal-body");if(n.innerHTML="",t.hasOwnProperty("versions")&&0!=t.versions.length)for(var s in t.versions){var r=document.createElement("div");r.className="versions";var a=document.createElement("div");a.className="versions__date",a.textContent=s;var o=document.createElement("div");o.className="versions__container",t.versions[s].forEach((e=>{var t=document.createElement("a"),i=new Date(1e3*e.create),n=`${i.getHours().toString().padStart(2,"0")}:${i.getMinutes().toString().padStart(2,"0")}`;t.innerHTML="",e.hasOwnProperty("current")&&(t.innerHTML+='<i class="bi bi-star-fill"></i>'),this.version_id===e.id&&(t.innerHTML+='<i class="bi bi-eye"></i>'),t.innerHTML+=n,t.href=`/${this.post_id}/${e.id}`,t.target="_blank",o.append(t)})),r.append(a),r.append(o),n.append(r)}else n.textContent=window.app.l10n("editor.history-empty");e.classList.remove(i)})).catch((e=>{t.hide(),window.app.error(window.app.l10n("editor.error-load-history"))}))}}}}_ignoreBlockType=["code","delimiter"];_isTypografRun=!1;async runTypograf(){if(!this.editorjs||!this.typograf||this._isTypografRun)return;this._isTypografRun=!0;let e=this.btnTypograf.innerHTML;this.btnTypograf.innerHTML=a.A,await this.save();let t=this.editorjs.blocks.getBlocksCount();for(let e=0;e<t;e++){let t=this.editorjs.blocks.getBlockByIndex(e);this._ignoreBlockType.includes(t.name)||t.holder.querySelectorAll("[contenteditable], .cdx-input").forEach((e=>{e.value?e.value=this.typograf.execute(e.value):e.innerHTML=this.typograf.execute(e.innerHTML)}))}this.btnTypograf.innerHTML=e,this._isTypografRun=!1}},"game-unit":class{constructor(){const e=document.querySelector(".game-unit");if(!e)return;this.rootNode=e;let t=document.getElementById("game-unit-initial"),i=JSON.parse(t.value);this.unitId=i.id,this.gameId=i.gameId,this.treeId=i.treeId,i.isFavorite&&this.rootNode.classList.add("game-unit--favorite"),this._setFavoriteCounter(i.favoriteCount),e.querySelector(".game-unit_cover-item")&&window.app.loadModule("photoswipe").then((({default:e})=>{const t=new e.PhotoSwipeLightbox({gallery:".game-unit_card",children:".game-unit_cover-item",thumbSelector:".game-unit_cover-item",hideAnimationDuration:0,pswpModule:e.PhotoSwipe});t.on("uiRegister",(function(){t.pswp.ui.registerElement(e.downloadButtonConfig)})),t.init()}));const n=document.getElementById("game-unit_share");n&&(navigator.share?n.addEventListener("click",(()=>{const e={title:document.title,text:window.app.getMetaByName("description"),url:window.location.origin+window.location.pathname};navigator.share(e)})):n.remove());const s=e.querySelector(".game-unit_compare-wrapper");s&&new $(this.gameId,this.treeId,s);const r=document.getElementById("game-unit_cockpit");r&&r.addEventListener("click",(()=>{this.openCockpitPopup(r.getAttribute("data-image-url"))}));const a=document.getElementById("game-unit_game-view");a&&a.addEventListener("click",(()=>{this.showUnit()})),this.showInGameButton=a;const o=document.getElementById("game-unit_game-view-help");if(o.addEventListener("click",(()=>{this.openShowUnitGuestModal()})),this.showInGameHelpButton=o,e.querySelectorAll(".game-unit_favorite-button").forEach((t=>{t.addEventListener("click",(()=>{e.classList.contains("game-unit--favorite")?this.setFavorite(!1):this.setFavorite(!0)}))})),e.querySelectorAll(".game-unit_score").forEach((e=>{if(!e.hasAttribute("data-nomination-id"))return;let t=e.getAttribute("data-nomination-id");new V(this.unitId,e,i.canVote,i.scores[t]??{})})),!i.canVote&&null!==window.app.getLoginUser()){const t=e.querySelector("#user-score-alert");t?.classList.remove("d-none")}const d=e.querySelector(".game-unit_mods .accordion-collapse");if(d){let t=e.querySelector(".game-unit_mods");d.addEventListener("shown.bs.collapse",(()=>{if(t.classList.contains("js-loaded"))return;let e=t.querySelector(".game-unit_mods-wrapper"),i=t.querySelector(".game-unit_mods-canvas");i.width=e.clientWidth,i.height=e.clientHeight;let n=new U(e,i,{arrowPadding:-3});n.getCtx().fillStyle="#607D8B",e.querySelectorAll("[data-mod-req-id]").forEach((t=>{let i=t.getAttribute("data-mod-req-id"),s=e.querySelector(`[data-mod-id="${i}"]`);n.draw(s,t)})),t.classList.add("js-loaded")}))}let c=null;document.addEventListener("click",(e=>{if(c){if(c.tip.contains(e.target)||c._element.contains(e.target))return;c.hide(),c=null}let t=e.target.closest("[data-feature-popover]");if(t){let e=u.Popover.getInstance(t);if(!e){let i=document.createElement("div");i.innerHTML=t.getAttribute("data-feature-popover"),e=u.Popover.getOrCreateInstance(t,{customClass:"game-unit_popover shadow",content:i,html:!0,trigger:"manual",placement:"bottom"})}e.show(),c=e}})),document.getElementById("btnModeRealistic").addEventListener("click",(()=>{e.classList.remove("cur-char-ab"),e.classList.add("cur-char-rb")})),document.getElementById("btnModeArcade").addEventListener("click",(()=>{e.classList.remove("cur-char-rb"),e.classList.add("cur-char-ab")}));let h=document.getElementById("btnUnitTop"),m=document.getElementById("btnUnitBasic");h&&m&&(h.addEventListener("click",(()=>{e.classList.remove("cur-mod-basic"),e.classList.add("cur-mod-ref")})),m.addEventListener("click",(()=>{e.classList.remove("cur-mod-ref"),e.classList.add("cur-mod-basic")})));let p=document.getElementById("game-unit_feed");if(p){this.feed=l.init(p);let e=document.getElementById("game-unit_feed-nav");e&&e.addEventListener("click",(t=>{let i=t.target.closest("[data-feed-sort]");if(i){let t=i.getAttribute("data-feed-sort");this.feed.atributes.sort=t,e.querySelectorAll(".active[data-feed-sort]").forEach((e=>{e.classList.remove("active")})),i.classList.add("active"),this.feed.refresh()}}))}window.app.helper.yaMetrika("params",{unit_id:this.gameId,tree_id:this.treeId})}openCockpitPopup(e){window.app.loadModule("pannellum").then((({default:t})=>{let i=document.getElementById("cockpit-popup");if(!i){i=document.createElement("div"),i.id="cockpit-popup",i.classList.add("modal","fade","cockpit-popup"),i.setAttribute("aria-hidden","true");let t=document.createElement("div");t.classList.add("modal-dialog");let n=document.createElement("div");n.classList.add("modal-content"),t.appendChild(n),i.appendChild(t),document.body.appendChild(i);let s=window.pannellum.viewer(n,{type:"equirectangular",panorama:e,autoLoad:!0,strings:window.app.l10n("pannellum")});i.addEventListener("shown.bs.modal",(()=>{s.resize()}))}u.Modal.getOrCreateInstance(i).show(),window.app.helper.yaMetrika("reachGoal","WIKI3_UBTN_COCKPIT",{unit_id:this.gameId})}))}openShowUnitGuestModal(){if(!this.unitViewGuestModal){let e=D.A.render('<div class="modal fade" id="gameUnitViewForGuestModal" tabindex="-1" aria-modal="true" role="dialog" aria-hidden="true"> <style>@keyframes gameUnitViewForGuestModal_btn-animation{from{margin-left:0}to{margin-left:-100%}}.gameUnitViewForGuestModal_btn-register{position:relative;display:flex;align-items:center;justify-content:center;background-color:#e44844;color:#eee;padding:8px 10px 9px;transition:.2s;font-size:22px;text-align:center;border-radius:3px;width:100%;text-decoration:none;margin-top:10px;font-family:WTFont,Roboto,sans-serif;text-shadow:1px 1px 0 #000;transition:.5s;overflow:hidden}.gameUnitViewForGuestModal_btn-register_bg{position:absolute;left:0;top:0;width:240%;height:100%;background:repeating-linear-gradient(-45deg,#d30808,#d30808 2%,#aa0505 0,#aa0505 4%)}.gameUnitViewForGuestModal_btn-register:hover{background-color:red;box-shadow:0 0 17px 5px rgba(255,37,17,.5)}.gameUnitViewForGuestModal_btn-register:hover .gameUnitViewForGuestModal_btn-register_bg{animation:gameUnitViewForGuestModal_btn-animation 10s linear infinite;background:repeating-linear-gradient(-45deg,#e70808,#e70808 2%,#b70606 0,#b70606 4%)}</style> <div class="modal-dialog" style="max-width:400px"> <div class="modal-content"> <div class="modal-header"> <h1 class="modal-title fs-5" data-l10n-key="game-unit_view-guest-popup.header"></h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <form class="modal-form"> <div class="modal-body" style="font-size:1.1em"> <b class="mb-1" data-l10n-key="game-unit_view-guest-popup.player-header"></b> <ol> <li data-l10n-key="game-unit_view-guest-popup.player-row-1"></li> <li data-l10n-key="game-unit_view-guest-popup.player-row-2"></li> <li data-l10n-key="game-unit_view-guest-popup.player-row-3"></li> </ol> <hr> <b data-l10n-key="game-unit_view-guest-popup.guest-header"></b> <div data-l10n-key="game-unit_view-guest-popup.guest-row-1"></div> <a href="#" target="_blank" class="gameUnitViewForGuestModal_btn-register" onclick=\'app.helper.yaMetrika("reachGoal","WIKI3_UBTN_GSHOW_REG")\'> <div class="gameUnitViewForGuestModal_btn-register_bg"></div> <span style="z-index:1" data-l10n-key="game-unit_view-guest-popup.register-button"></span> </a> </div> </form> </div> </div> </div>');e.querySelector(".gameUnitViewForGuestModal_btn-register").href=this.showInGameHelpButton.getAttribute("data-register-link"),document.body.appendChild(e),this.unitViewGuestModal=u.Modal.getOrCreateInstance(e)}this.unitViewGuestModal.show()}isShowUnitProcess=!1;async showUnit(){if(this.isShowUnitProcess)return;if(null===window.app.getLoginUser())return void window.GSEA?.open();this.isShowUnitProcess=!0;let e=this.showInGameButton.innerHTML;this.showInGameButton.innerHTML=a.A;let t=new FormData;return t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t.append("unit_id",this.unitId),t.append("jwt",window.GSEA?.jwt),window.app.helper.yaMetrika("reachGoal","WIKI3_UBTN_GAMESHOW",{unit_id:this.gameId}),(0,s.A)("/api/gunitIngameShow",{method:"POST",credentials:"include",body:t}).then((e=>{e.success?window.app.success(window.app.l10n("game-unit.ingame-show-open")):window.app.error(e.message)})).finally((()=>{this.showInGameButton.innerHTML=e,this.isShowUnitProcess=!1}))}isFavoriteProgress=!1;setFavorite(e){if(this.isFavoriteProgress)return;if(null===window.app.getLoginUser())return void window.GSEA?.open();this.isFavoriteProgress=!0;let t=new FormData;return t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t.append("unit_id",this.unitId),t.append("value",e?1:0),(0,s.A)("/api/gunitFavorite",{method:"POST",credentials:"include",body:t}).then((e=>{e.success?(this.rootNode.classList.toggle("game-unit--favorite",e.data.is_favorite||!1),this._setFavoriteCounter(e.data.count)):window.app.error(e.message)})).finally((()=>{this.isFavoriteProgress=!1}))}_setFavoriteCounter(e){this.rootNode.querySelectorAll(".game-unit_favorite-value").forEach((t=>{t.innerText=e,e>0&&t.classList.remove("d-none")}));let t=this.rootNode.querySelectorAll(".game-unit_favorite-label"),i=window.app.l10n("game-unit.favorite-player",{value:e});t.forEach((e=>{e.innerText=i}))}},"unit-filter":class{constructor(){switch(this.gameAssetCDN=window.app.helper.getGameAssetCDN(),this.filtersPanel=document.getElementById("wt-filters-panel"),this.startPage=document.getElementById("wt-start-page"),this.buttonShowTree=document.getElementById("wt-show-tree"),this.buttonShowList=document.getElementById("wt-show-list"),this.buttonClearFilters=document.getElementById("wt-clear-filters"),this.filterAmountLabel=document.getElementById("wt-filters-amount-label"),this.filterAmount=document.getElementById("wt-filters-amount"),this.filterSpinner=document.getElementById("wt-filters-spinner"),this.filterSearch=document.getElementById("wt-filter-search"),this.filterCountryButton=document.getElementById("wt-filter-country"),this.filterCountryItems=document.getElementById("wt-filter-country-items"),this.filterRankButton=document.getElementById("wt-filter-rank"),this.filterRankItems=document.getElementById("wt-filter-rank-items"),this.filterRoleButton=document.getElementById("wt-filter-role"),this.filterRoleItems=document.getElementById("wt-filter-role-items"),this.filterStatusButton=document.getElementById("wt-filter-status"),this.filterStatusItems=document.getElementById("wt-filter-status-items"),this.filterBRButton=document.getElementById("wt-filter-br"),this.filterBrSlidersNodes=document.querySelectorAll("#wt-filter-br-items .unit-filter_slider"),this.unitTreesBlock=document.getElementById("wt-unit-trees"),this.unitListBlock=document.getElementById("wt-unit-list"),this.collectionsButton=document.getElementById("wt-filter-collections"),this.collectionsModal=document.getElementById("wt-filter-collections-modal"),this.currentTreeNode=null,this.brModeButton=document.getElementById("wt-br-mode-btn"),this.brModeItems=document.getElementById("wt-br-mode-items"),this.treeTabs=document.getElementById("wt-tree-tabs"),this.initFilters(),this.initTrees(),this.setBrMode("rb"),this._fillList(),this.getURLParam("v")){case"t":this.showTree(this.getURLParam("t_c"),!1);break;case"l":this.showList(!1);break;default:window.history.replaceState({v:null},null,window.location.href)}window.addEventListener("popstate",(e=>{if(e.state&&"v"in e.state)switch(e.state.v){case"t":this.showTree(e.state.t_c||null,!1);break;case"l":this.showList(!1);break;case null:this.showStartPage(!1)}})),this.filtersPanel.classList.remove("unready"),this.filterSpinner.style.display="none",window.addEventListener("resize",(()=>{this._updateCurrentTreeZoom()}))}_updateCurrentTreeZoom(){if(!this.currentTreeNode)return;let e=this.currentTreeNode.querySelector(".wt-tree"),t=this.currentTreeNode.querySelector(".wt-tree_wrapper"),i=this.currentTreeNode.querySelector(".unit-tree_zoom");if(e.offsetWidth>=t.offsetWidth?i.style.display="none":i.style.display="",t.classList.contains("zoomed")){let i=e.offsetWidth/t.offsetWidth;t.style.transform=i>=1?"":`scale(${i})`}}getURLParam(e){return new URL(window.location.href).searchParams.get(e)}setURLParams(e,t=!0){if(t){let t=new URL(window.location.href);for(let i in e){let n=e[i];null===n?t.searchParams.delete(i):t.searchParams.set(i,n)}window.history.pushState(e,null,t)}}initFilters(){this._searchClearTextRegex=new RegExp(/[^0-9a-zа-яё]/,"ig"),this.buttonShowTree.addEventListener("click",(()=>{this.buttonShowTree.classList.contains("active")?this.showStartPage():this.showTree()})),this.buttonShowList.addEventListener("click",(()=>{this.buttonShowList.classList.contains("active")?this.showStartPage():this.showList()})),this.buttonClearFilters.addEventListener("click",(()=>{this.clearFilters()})),this.units=JSON.parse(window.WT_UnitList)||[],this.unitLowerNames={},this.units.forEach((e=>{this.unitLowerNames[e[0]]=e[1].replace(this._searchClearTextRegex,"").toLowerCase()})),this.filterSearch.timer=void 0,this.filterSearch.addEventListener("input",(()=>{void 0!==this.filterSearch.timer&&clearTimeout(this.filterSearch.timer),this.filterSearch.timer=setTimeout((()=>{this.filter("s",this.filterSearch.value),this.filterSearch.timer=void 0,""!==this.filterSearch.value?this.filterSearch.classList.add("active"):this.filterSearch.classList.remove("active")}),500)})),this.filterCountryItems.querySelectorAll("[data-country-id]").forEach((e=>{e.addEventListener("click",(()=>{e.classList.toggle("active");var t=[];this.filterCountryItems.querySelectorAll(".active[data-country-id]").forEach((e=>{t.push(e.getAttribute("data-country-id"))})),t.length>0?this.filterCountryButton.classList.add("active"):this.filterCountryButton.classList.remove("active"),this.filter("c",t)}))})),this.filterRankItems.querySelectorAll("[data-rank-id]").forEach((e=>{e.addEventListener("click",(()=>{e.classList.toggle("active");var t=[];this.filterRankItems.querySelectorAll(".active[data-rank-id]").forEach((e=>{t.push(parseInt(e.getAttribute("data-rank-id")))})),t.length>0?this.filterRankButton.classList.add("active"):this.filterRankButton.classList.remove("active"),this.filter("r",t)}))})),this.filterRoleItems.addEventListener("click",(e=>{let t=e.target.closest("[data-collection-id]");if(!t)return;let i=this._currentFilters.rl||[],n=parseInt(t.getAttribute("data-collection-id"));i.includes(n)?i=i.filter((e=>e!==n)):i.push(n),this.filter("rl",i)})),this.filterStatusItems.querySelectorAll("[data-status-id]").forEach((e=>{e.addEventListener("click",(()=>{e.classList.toggle("active");var t=[];this.filterStatusItems.querySelectorAll(".active[data-status-id]").forEach((e=>{t.push(parseInt(e.getAttribute("data-status-id")))})),t.length>0?this.filterStatusButton.classList.add("active"):this.filterStatusButton.classList.remove("active"),this.filter("exp",t)}))})),this.brSliders={},this.filterBrSlidersNodes.forEach((e=>{const t=e.getAttribute("data-filter-br"),i=parseInt(e.getAttribute("data-filter-br-max")),n=function(e,t){if(!e||!e.nodeName)throw new Error("noUiSlider: create requires a single element, got: "+e);if(e.noUiSlider)throw new Error("noUiSlider: Slider was already initialized.");var i=Be(e,qe(t),t);return e.noUiSlider=i,i}(e,(e=>({start:[0,e],step:1,connect:!0,range:{min:0,max:e},tooltips:{to:e=>(Math.round(e/3*10)/10+1).toFixed(1)}}))(i));n.on("change",((e,n,s)=>{this.filter("br",{id:t,maxBr:i,data:s})})),this.brSliders[t]=n})),this.collectionsModal&&(this.collectionsModal.addEventListener("click",(e=>{if(!e.target.closest(".form-check"))return;let t=this.collectionsModal.querySelectorAll('[name="unit-collection"]:checked'),i={};t.forEach((e=>{let t=e.getAttribute("data-group-id"),n=parseInt(e.getAttribute("value"));i.hasOwnProperty(t)?i[t].push(n):i[t]=[n]})),this.filter("col",i)})),new u.Tab(this.collectionsModal.querySelector("#filter-group-tab:first-child button")).show()),this.brModeItems.addEventListener("click",(e=>{e.target.hasAttribute("data-br-id")&&this.setBrMode(e.target.getAttribute("data-br-id"))}))}initTrees(){this.treeTabs.querySelectorAll("[data-tree-target]").forEach((e=>{e.addEventListener("click",(()=>{this.showTree(e.getAttribute("data-tree-target"))}))})),document.addEventListener("click",(e=>{this.unitTreesBlock.querySelectorAll(".wt-tree_group.open").forEach((t=>{t.contains(e.target)||t.classList.remove("open")}))}));const e=document.createElement("span");e.className="br",this.unitTreesBlock.querySelectorAll(".wt-tree_item").forEach((t=>{t.append(e.cloneNode())}))}showTree(e=null,t=!0){if(this.startPage.style.display="none",this.unitListBlock.style.display="none",this.unitTreesBlock.style.display=null,this.buttonShowList.classList.remove("active"),this.buttonShowTree.classList.add("active"),null===e&&null!==this.getURLParam("t_c")&&(e=this.getURLParam("t_c")),"string"==typeof e?null===this.treeTabs.querySelector(`[data-tree-target="${e}"`)&&(e=null):e=null,null===e){var i=this.treeTabs.querySelector("[data-tree-target]");e=i.getAttribute("data-tree-target")}this.treeTabs.querySelectorAll("[data-tree-target]").forEach((t=>{t.getAttribute("data-tree-target")===e?t.classList.add("active"):t.classList.remove("active")})),this.unitTreesBlock.querySelectorAll(".unit-tree").forEach((t=>{t.getAttribute("data-tree-id")===e?(t.style.display=null,this.initTree(t.querySelector(".wt-tree")),this.currentTreeNode=t,this._updateCurrentTreeZoom()):t.style.display="none"})),this.setURLParams({v:"t",t_c:e},t)}showList(e=!0){this.startPage.style.display="none",this.unitTreesBlock.style.display="none",this.initList(),this.unitListBlock.style.display=null,this.buttonShowTree.classList.remove("active"),this.buttonShowList.classList.add("active"),this.currentTreeNode=null,this.setURLParams({v:"l"},e)}showStartPage(e=!0){this.buttonShowList.classList.remove("active"),this.buttonShowTree.classList.remove("active"),this.startPage.style.display=null,this.unitTreesBlock.style.display="none",this.unitListBlock.style.display="none",this.currentTreeNode=null,this.setURLParams({v:null},e)}setBrMode(e){const t=this.brModeItems.querySelectorAll("button[data-br-id]");let i=null;t.forEach((t=>{t.getAttribute("data-br-id")===e?i=t:t.classList.remove("active")})),null===i&&(i=t[0],e=i.getAttribute("data-br-id")),this.brMode=e,i.classList.add("active"),this.brModeButton.innerText=i.getAttribute("data-br-sname"),this.unitListBlock.querySelectorAll(".wt-ulist_unit td.br").forEach((e=>{const t=e.parentElement.getAttribute("data-ulist-id"),i=this.units.find((e=>e[0]===t));e.innerText=void 0!==i[4][this.brMode]?this.convertBR(i[4][this.brMode]):"—",e.setAttribute("data-value",i[4][this.brMode]??-1)})),this.unitTreesBlock.querySelectorAll(".wt-tree_item .br").forEach((e=>{const t=e.parentElement.getAttribute("data-unit-id"),i=this.units.find((e=>e[0]===t));e.innerText=this.convertBR(i[4][this.brMode])}))}_highlightUnits(e){var t=this.unitListBlock.querySelector(".wt-ulist_instance");Array.from(t.tBodies[0].rows).forEach((t=>{var i=t.getAttribute("data-ulist-id");null==e?t.style.display=null:-1==e.indexOf(i)?t.style.display="none":t.style.display=null})),this.unitTreesBlock.querySelectorAll(".unit-tree").forEach((t=>{var i=t.querySelector(".wt-tree");if(null==e)return i.classList.remove("wt-tree--fade"),i.querySelectorAll(".wt-tree_item.highlight, .wt-tree_group.highlight").forEach((e=>{e.classList.remove("highlight")})),void this.treeTabs.querySelectorAll(".navtabs_item").forEach((e=>{e.classList.remove("highlight")}));i.classList.add("wt-tree--fade");var n=!1;i.querySelectorAll("td > .wt-tree_item[data-unit-id]").forEach((t=>{var i=t.getAttribute("data-unit-id");-1!=e.indexOf(i)?(n=!0,t.classList.add("highlight")):t.classList.remove("highlight")})),i.querySelectorAll("td > .wt-tree_group").forEach((t=>{var i=!1;t.querySelectorAll(".wt-tree_item[data-unit-id]").forEach((t=>{var s=t.getAttribute("data-unit-id");-1!=e.indexOf(s)?(n=!0,i=!0,t.classList.add("highlight")):t.classList.remove("highlight")})),i?t.classList.add("highlight"):t.classList.remove("highlight")}));var s=t.getAttribute("data-tree-id"),r=this.treeTabs.querySelector(`.navtabs_item[data-tree-target="${s}"]`);r&&(n?r.classList.add("highlight"):r.classList.remove("highlight"))}))}_findFilterMatch(){var e=[];return this.units.forEach((t=>{if(!(this._currentFilters.hasOwnProperty("s")&&-1==this.unitLowerNames[t[0]]?.indexOf(this._currentFilters.s)&&t[0]!==this._currentFilters.s_orig||this._currentFilters.hasOwnProperty("c")&&-1==this._currentFilters.c.indexOf(t[2])||this._currentFilters.hasOwnProperty("r")&&-1==this._currentFilters.r.indexOf(t[3])||this._currentFilters.hasOwnProperty("rl")&&0===this._currentFilters.rl.filter((e=>t[6].includes(e))).length||this._currentFilters.hasOwnProperty("exp")&&-1==this._currentFilters.exp.indexOf(t[5]))){if(this._currentFilters.hasOwnProperty("br"))for(let e in this._currentFilters.br)if(void 0===t[4][e]||t[4][e]<this._currentFilters.br[e][0]||t[4][e]>this._currentFilters.br[e][1])return;if(this._currentFilters.hasOwnProperty("col"))for(let e in this._currentFilters.col)if(0===this._currentFilters.col[e].filter((e=>t[6].includes(e))).length)return;e.push(t[0])}})),e}_currentFilters={};filter(e,t){switch(e){case"s":const i=t.replace(this._searchClearTextRegex,"").toLowerCase();""==i?(delete this._currentFilters.s,delete this._currentFilters.s_orig):(this._currentFilters.s=i,this._currentFilters.s_orig=t.toLowerCase().trim());break;case"c":case"r":case"rl":case"exp":0==t.length?delete this._currentFilters[e]:this._currentFilters[e]=t;break;case"br":let n=this._currentFilters.br??{};0==t.data.length||0==t.data[0]&&t.data[1]==t.maxBr?delete n[t.id]:n[t.id]=[parseInt(t.data[0]),parseInt(t.data[1])],Object.keys(n).length>0?this._currentFilters.br=n:delete this._currentFilters.br;break;case"col":(e=>{for(var t in e)return!1;return!0})(t)?delete this._currentFilters[e]:this._currentFilters[e]=t}if(0===Object.keys(this._currentFilters).length)this.clearFilters();else{this.filterAmountLabel.style.display=null,this.filterSpinner.style.display=null,"l"!=this.getURLParam("v")&&"t"!=this.getURLParam("v")&&this.showList();let e=this._findFilterMatch();this._highlightUnits(e),this.filterAmount.innerText=e.length,this.filterSpinner.style.display="none",this.filterAmount.style.display=null,this.buttonClearFilters.style.display=null;let t=this.filterRoleItems.querySelectorAll("[data-collection-id]"),i=this._currentFilters.rl||[];if(this.filterRoleButton.classList.toggle("active",i.length>0),t.forEach((e=>{let t=parseInt(e.getAttribute("data-collection-id"));e.classList.toggle("active",i.includes(t))})),this._currentFilters.hasOwnProperty("br")?this.filterBRButton.classList.add("active"):this.filterBRButton.classList.remove("active"),this.collectionsButton&&(this._currentFilters.hasOwnProperty("col")?this.collectionsButton.classList.add("active"):this.collectionsButton.classList.remove("active")),this.collectionsModal){const e=this._currentFilters.col||{},t=Object.values(e);let i=[];t.forEach((e=>{i=i.concat(...e)})),this.collectionsModal.querySelectorAll('[name="unit-collection"]').forEach((e=>{const t=parseInt(e.getAttribute("value"));e.checked=i.includes(t)}))}}}clearFilters(){this.filterAmount.style.display="none",this.filterAmountLabel.style.display="none",this.filterSpinner.style.display="none",this.buttonClearFilters.style.display="none",this.filterSearch.value="",this.filterSearch.classList.remove("active"),this.filterCountryButton.classList.remove("active"),this.filterCountryItems.querySelectorAll(".active[data-country-id]").forEach((e=>{e.classList.remove("active")})),this.filterRankButton.classList.remove("active"),this.filterRankItems.querySelectorAll(".active[data-rank-id]").forEach((e=>{e.classList.remove("active")})),this.filterRoleButton.classList.remove("active"),this.filterRoleItems.querySelectorAll(".active[data-collection-id]").forEach((e=>{e.classList.remove("active")})),this.filterStatusButton.classList.remove("active"),this.filterStatusItems.querySelectorAll(".active[data-status-id]").forEach((e=>{e.classList.remove("active")})),this.filterBRButton.classList.remove("active");for(let e in this.brSliders)this.brSliders[e].reset();this.collectionsModal&&(this.collectionsButton.classList.remove("active"),this.collectionsModal.querySelectorAll('[name="unit-collection"]:checked').forEach((e=>{e.checked=!1}))),this._currentFilters={},this._highlightUnits(null)}initTree(e){if(e.classList.contains("js-loaded"))return;const t=e.querySelector(".wt-tree_footer");e.querySelectorAll(".wt-tree_group").forEach((i=>{i.addEventListener("click",(()=>{i.classList.add("open");const n=i.querySelector(".wt-tree_group-items");if(!i.classList.contains("js-loaded")){var s=i.querySelector(".wt-tree_group-canvas");s.width=n.clientWidth,s.height=n.clientHeight;let e=new U(i,s);e.getCtx().fillStyle="#607D8B",i.querySelectorAll("[data-unit-req]").forEach((t=>{if(i.contains(t)){var n=t.getAttribute("data-unit-req"),s=i.querySelector(`[data-unit-id="${n}"]`);s&&e.draw(s,t)}})),i.classList.add("js-loaded")}const r=U.getPosFromNode(e,document)[1],a=e.getBoundingClientRect().height,o=U.getPosFromNode(n,document)[1]+n.getBoundingClientRect().height-(r+a);o>0&&(t.style.height=parseInt(o)+25+"px")}))})),window.getComputedStyle(document.body).marginTop;var i=e.querySelector(".wt-tree-canvas");i.height=e.clientHeight;let n=new U(e,i);n.getCtx().fillStyle="#607D8B",e.querySelectorAll("td > [data-unit-req]").forEach((t=>{if(e.contains(t)){var i=t.getAttribute("data-unit-req"),s=e.querySelector(`[data-unit-id="${i}"]`);s&&n.draw(s,t)}}));let s=e.querySelector(".wt-tree_wrapper"),r='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 -960 960 960" fill="currentColor"><path d="M765-144 526-384q-30 23-65.792 35.5T384.035-336Q284-336 214-406t-70-170q0-100 70-170t170-70q100 0 170 70t70 170.035q0 40.381-12.5 76.173T577-434l239 239-51 51ZM384-408q70 0 119-49t49-119q0-70-49-119t-119-49q-70 0-119 49t-49 119q0 70 49 119t119 49Zm-96-132v-72h192v72H288Z"></path></svg>',a=document.createElement("button");a.className="unit-tree_zoom",a.innerHTML=r,a.addEventListener("click",(()=>{if(s.classList.contains("zoomed"))a.innerHTML=r,e.style.overflowX="",e.style.height="",s.style.transform="",s.classList.remove("zoomed");else{let t=e.offsetWidth/s.offsetWidth;s.style.transform=t>=1?"":`scale(${t})`,e.scrollLeft=0,e.style.overflowX="hidden";let i=s.offsetHeight*t;e.style.height=i+"px",a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 -960 960 960" fill="currentColor"><path d="M765-144 526-384q-30 23-65.792 35.5T384.035-336Q284-336 214-406t-70-170q0-100 70-170t170-70q100 0 170 70t70 170.035q0 40.381-12.5 76.173T577-434l239 239-51 51ZM384-408q70 0 119-49t49-119q0-70-49-119t-119-49q-70 0-119 49t-49 119q0 70 49 119t119 49Zm-36-60v-72h-72v-72h72v-72h72v72h72v72h-72v72h-72Z"/></svg>',s.classList.add("zoomed")}})),e.after(a),e.classList.add("js-loaded")}_fillList(){let e=this.unitListBlock.querySelector(".wt-ulist tbody");if(0!==e.childElementCount)return;let t=new DocumentFragment,i=document.getElementById("wt-ulist_list-row-template");this.units.forEach((e=>{let n=i.content.cloneNode(!0),s=n.querySelector("tr");switch(s.setAttribute("data-ulist-id",e[0]),e[5]){case 0:s.classList.add("wt-ulist_unit--regular");break;case 1:s.classList.add("wt-ulist_unit--prem");break;case 2:s.classList.add("wt-ulist_unit--squad")}let r=n.querySelectorAll("td");const a=e[7][2]||e[0];if(r[0].innerHTML=`<a href="/unit/${e[0]}"><img src="${this.gameAssetCDN}/icons/${a}_ico.svg" loading="lazy" decoding="async"><span>${e[1]}</span></a>`,r[1].innerHTML=`<svg width="18" height="18" viewBox="0 0 10 10" color="${e[7][0][2]}"><use href="/static/class_icon/${e[7][0][0]}.svg#icon" width="10" height="10" x="0" y="0"></use></svg><span class="ms-1">${e[7][0][1]}</span>`,r[2].setAttribute("data-value",e[2]),r[2].innerHTML=`<img src="/static/country_svg/country_${e[2]}.svg" loading="lazy" decoding="async">`,r[3].setAttribute("data-value",e[3]),r[3].innerText=this.convertRankRoman(e[3]),r[4].setAttribute("data-value",e[4][this.brMode]??-1),r[4].innerText=void 0!==e[4][this.brMode]?this.convertBR(e[4][this.brMode]):"—",0===e[7][1].length)r[5].setAttribute("data-value",-1),r[5].innerText="—";else{r[5].setAttribute("data-value",e[7][1][0]);let t="";e[7][1][0]>0&&("g"===e[7][1][2]?t="item_type_eagles":"w"===e[7][1][2]&&(t="item_type_warpoints")),r[5].innerHTML=e[7][1][1]+(t?` <img src="${this.gameAssetCDN}/gui_skin/${t}.svg" width="18px" loading="lazy" decoding="async">`:"")}t.append(n)})),e.append(t)}initList(){let e=this.unitListBlock.querySelector(".wt-ulist");e.classList.contains("js-loaded")||(this.unitList=new Fe.A(e),e.classList.add("js-loaded"))}convertRankRoman(e){switch(e){case 1:return"I";case 2:return"II";case 3:return"III";case 4:return"IV";case 5:return"V";case 6:return"VI";case 7:return"VII";case 8:return"VIII";case 9:return"IX";case 10:return"X"}return""}convertBR(e){return(e/3+1).toFixed(1)}},"unit-compare":class{constructor(){try{let e=document.getElementById("unit-compare_initial"),t=JSON.parse(e.value);if(0===t.trees.length||0===t.unitsData.length||0===Object.keys(t.typesConfig).length)throw new Error("Empty params");this.compareConfig=t}catch(e){return window.app.error(window.app.l10n("unit-compare.init-error")),void console.log(e)}this.gameAssetCDN=window.app.helper.getGameAssetCDN(),this.nodes={root:document.querySelector(".unit-compare"),treeTabsContainer:document.querySelector(".unit-compare_tree-tabs"),unitItemsContainer:document.querySelector(".unit-compare_items"),dataSectionsContainer:document.querySelector(".unit-compare_sections"),templateUnitItem:document.getElementById("tpl-unit-compare-item"),templateUnitItemEmpty:document.getElementById("tpl-unit-compare-empty"),templateSection:document.getElementById("tpl-unit-compare-section"),buttonShare:document.getElementById("btn-unit-compare-share"),buttonClean:document.getElementById("buttonCleanList"),buttonSelectTreeDropdown:document.getElementById("btn-select-tree-dropdown"),switchOnlyDiff:document.getElementById("switchOnlyDiff"),selectModal:document.getElementById("unitCompareSelectModal"),modalSelectItems:document.querySelector(".unit-compare_select-items"),miniHeader:document.querySelector(".unit-compare_mini-header"),btnModeRealistic:document.getElementById("switchModRealistic"),btnModeArcade:document.getElementById("switchModArcade")},this.nodes.btnModeRealistic.addEventListener("click",(()=>{this.nodes.root.classList.remove("cur-char-ab"),this.nodes.root.classList.add("cur-char-rb")})),this.nodes.btnModeArcade.addEventListener("click",(()=>{this.nodes.root.classList.remove("cur-char-rb"),this.nodes.root.classList.add("cur-char-ab")}));let e={};this.compareConfig.unitsData.forEach((t=>{let i=t.tree;e.hasOwnProperty(i)?e[i]++:e[i]=1})),this.trees={},this.compareConfig.trees.forEach((t=>{if(!e.hasOwnProperty(t.id))return;t.unitCount=e[t.id];let i=document.createElement("button");i.type="button",i.className="feed-filter",i.innerHTML=`${t.label} <span class="badge text-bg-primary ms-2">${t.unitCount}</span>`,i.addEventListener("click",(()=>{this.setCurrentTree(t.id)})),this.nodes.treeTabsContainer.append(i),t.tabButton=i,this.trees[t.id]=t})),this.maxColumn=this._getMaxColumn(),this.currentUnitsId=null;let t=null,i=this.getURLParam("unitIds");i&&0!==i.trim().length&&(t=i.split(",").slice(0,this.maxColumn));let n=parseInt(this.getURLParam("tree"));this.setCurrentTree(n,t),this.nodes.buttonShare.addEventListener("click",(()=>{let e=new URL(window.location.href);e.searchParams.set("tree",this.currentTree),e.searchParams.set("unitIds",this.currentUnitsId.join(",")),navigator.clipboard.writeText(e.toString()).then((()=>{window.app.success(window.app.l10n("comment.link-copy"))})).catch((e=>{window.app.error(window.app.l10n("comment.link-copy-error"))}))})),this.nodes.buttonClean.addEventListener("click",(()=>{window.app.deleteCookie("unitsCompare"),window.location.href="/"})),this.showOnlyDiff=!1,this.nodes.switchOnlyDiff.addEventListener("change",(()=>{this.showOnlyDiff=this.nodes.switchOnlyDiff.checked,this._showForTree()})),this.selectModalBs=u.Modal.getOrCreateInstance(this.nodes.selectModal),window.addEventListener("resize",(()=>{let e=this._getMaxColumn();this.maxColumn!==e&&(this.maxColumn=e,this._showForTree())})),document.addEventListener("scroll",(()=>{let e=this.nodes.unitItemsContainer.getBoundingClientRect();this.nodes.miniHeader.classList.toggle("show",e.bottom-50<0)}))}_getMaxColumn(){let e=parseInt(window.getComputedStyle(document.body).getPropertyValue("--bs-breakpoint-md"));return window.innerWidth>=e?4:2}getURLParam(e){return new URL(window.location.href).searchParams.get(e)}setCurrentTree(e,t=null){if(!((e=parseInt(e))in this.trees)){let e=Object.keys(this.trees);return 0===e.length?void(window.location.href="/"):void this.setCurrentTree(e[0])}this.currentUnitsId=null,this.currentTree=e;for(let t in this.trees)this.trees[t].tabButton.classList.toggle("active",this.trees[t].id===e),this.trees[t].id===e&&(this.nodes.buttonSelectTreeDropdown.innerHTML=this.trees[t].tabButton.innerHTML);this._showForTree(t)}_showForTree(e=null){let t=[],i=[];if(null===this.currentUnitsId&&null===e)for(let e in this.compareConfig.unitsData){let n=this.compareConfig.unitsData[e];if(n.tree===this.currentTree&&(t.push(n.gameId),i.push(n)),i.length>=this.maxColumn)break}else(e||this.currentUnitsId).forEach((e=>{let n=this.compareConfig.unitsData.find((t=>t.gameId===e&&t.tree===this.currentTree));n&&(t.includes(e)||(t.push(e),i.push(n)))})),t=t.slice(0,this.maxColumn),i=i.slice(0,this.maxColumn);this.currentUnitsId=t,this._drawCompare(i),this._drawSelectModal()}_drawSelectModal(){let e=[];this.compareConfig.unitsData.forEach((t=>{t.tree===this.currentTree&&e.push(t)})),e.sort(((e,t)=>e.gameId>t.gameId)),this.nodes.modalSelectItems.innerHTML="",e.forEach((e=>{let t=this._getUnitSelectElem(e);this.nodes.modalSelectItems.append(t)}))}_drawCompare(e){let t=this.trees[this.currentTree];if(this.nodes.unitItemsContainer.innerHTML="",this.nodes.dataSectionsContainer.innerHTML="",e.forEach((e=>{let t=this._getUnitCardElem(e);this.nodes.unitItemsContainer.append(t),this.nodes.miniHeader.innerHTML=this.nodes.unitItemsContainer.innerHTML})),e.length<this.maxColumn){let i=this.nodes.templateUnitItemEmpty.content.cloneNode(!0),n={buttonAdd:i.querySelector(".unit-compare_empty-item_btn-add"),buttonSearch:i.querySelector(".unit-compare_empty-item_btn-search")};t.unitCount>e.length?n.buttonAdd.addEventListener("click",(()=>{this._openChangeUnitModal()})):n.buttonAdd.remove(),n.buttonSearch.addEventListener("click",(()=>{let e="/";switch(this.currentTree){case 0:e="/aviation";break;case 1:e="/helicopters";break;case 2:e="/ground";break;case 3:e="/ships";break;case 4:e="/boats"}window.location.href=e})),this.nodes.unitItemsContainer.append(i)}if(e.length>0){let i=this.compareConfig.typesConfig[t.unitType],n=1;i.forEach((t=>{let i=[];if(t.rows.forEach((t=>{let n=[],s=[];if(e.forEach((e=>{t.id in e.compareData?(n.push(e.compareData[t.id]),"value"in e.compareData[t.id]&&s.push(e.compareData[t.id].value)):n.push(null)})),n.every((e=>null===e)))return;let r=n.every((e=>n[0]?.label===e?.label));this.showOnlyDiff&&r||(t.data=n,1===t.compareMethod?t.maxValue=r?null:Math.max(...s):2===t.compareMethod&&(t.minValue=r?null:Math.min(...s)),i.push(t))})),0===i.length)return;let s=this.nodes.templateSection.content.cloneNode(!0),r={sectionHeader:s.querySelector(".accordion-button"),sectionContent:s.querySelector(".accordion-body"),sectionContentWrapper:s.querySelector(".accordion-collapse")},a=`unit-compare-section-${n}`;r.sectionHeader.setAttribute("data-bs-target","#"+a),r.sectionHeader.setAttribute("aria-controls",a),r.sectionHeader.innerText=t.title,r.sectionContentWrapper.id=a,n++,i.forEach((e=>{let t=document.createElement("div");t.className="unit-compare_row";let i=document.createElement("div");i.className="unit-compare_row-header",i.innerText=e.title;let n=document.createElement("div");n.className="unit-compare_row-content",e.data.forEach((t=>{let i=document.createElement("div");i.className="unit-compare_row-value",i.innerHTML=null===t?e.emptyLabel||"—":t.label,e.data.length>1&&(1===e.compareMethod&&t?.value===e.maxValue||2===e.compareMethod&&t?.value===e.minValue)&&i.classList.add("highlight"),n.append(i)})),t.append(i),t.append(n),r.sectionContent.append(t)})),this.nodes.dataSectionsContainer.append(s)}))}}_openChangeUnitModal(e=null){this.changedUnitId=e,this.selectModalBs.show()}_getUnitCardElem(e){let t=this._getUnitElem(e),i={itemBtnChange:t.querySelector(".unit-compare_item-btn-change"),itemBtnRemove:t.querySelector(".unit-compare_item-btn-remove")};return i.itemBtnChange.addEventListener("click",(()=>{this._openChangeUnitModal(e.gameId)})),i.itemBtnRemove.addEventListener("click",(()=>{this.removeFromShow(e.gameId)})),t}_getUnitSelectElem(e){const t=this._getUnitElem(e),i={root:t.querySelector(".unit-compare_item"),itemBtnChange:t.querySelector(".unit-compare_item-btn-change"),itemBtnRemove:t.querySelector(".unit-compare_item-btn-remove")};return this.currentUnitsId.includes(e.gameId)&&i.root.classList.add("active"),i.itemBtnChange.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M450.001-450.001h-230v-59.998h230v-230h59.998v230h230v59.998h-230v230h-59.998v-230Z"/></svg>',i.itemBtnChange.addEventListener("click",(()=>{if(this.changedUnitId){const t=this.currentUnitsId.indexOf(e.gameId),i=this.currentUnitsId.indexOf(this.changedUnitId);if(-1!==i&&-1!==t){let e=this.currentUnitsId[i];this.currentUnitsId[i]=this.currentUnitsId[t],this.currentUnitsId[t]=e}else-1!==i?this.currentUnitsId[i]=e.gameId:this.currentUnitsId.push(e.gameId)}else this.currentUnitsId.push(e.gameId);this._showForTree(),this.selectModalBs.hide()})),i.itemBtnRemove.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 -960 960 960" fill="currentColor"><path d="M324.309-164.001q-26.623 0-45.465-18.843-18.843-18.842-18.843-45.465V-696h-48v-51.999H384v-43.384h192v43.384h171.999V-696h-48v467.257q0 27.742-18.65 46.242-18.65 18.5-45.658 18.5H324.309ZM648-696H312v467.691q0 5.385 3.462 8.847 3.462 3.462 8.847 3.462h311.382q4.616 0 8.463-3.846 3.846-3.847 3.846-8.463V-696ZM400.155-288h51.999v-336h-51.999v336Zm107.691 0h51.999v-336h-51.999v336ZM312-696V-216v-480Z" /></svg>',i.itemBtnRemove.addEventListener("click",(()=>{i.root.remove(),this.removeUnit(e.gameId)})),t}_getUnitElem(e){let t=this.nodes.templateUnitItem.content.cloneNode(!0),i={itemFlag:t.querySelector(".unit-compare_item-flag"),itemImg:t.querySelector(".unit-compare_item-img"),itemLink:t.querySelector(".unit-compare_item-title"),itemTitle:t.querySelector(".unit-compare_item-title span"),itemPremIcon:t.querySelector(".unit-compare_item-title img"),itemCountryFlag:t.querySelector(".unit-compare_item-country img"),itemCountryName:t.querySelector(".unit-compare_item-country div"),itemRank:t.querySelector(".unit-compare_item-rank")};const n=e.originCountry||e.country.id,s=e.unitImageId||e.gameId;return i.itemFlag.src=`${this.gameAssetCDN}/unit_tooltip/country_${n}.png`,i.itemImg.src=`${this.gameAssetCDN}/images/${s}.png`,i.itemLink.href=e.link,i.itemTitle.innerText=e.name,i.itemCountryFlag.src=`/static/country_svg/country_${e.country.id}.svg`,i.itemCountryName.innerText=e.country.label,i.itemRank.innerText=e.rank,1!==e.expType&&i.itemPremIcon.remove(),t}removeFromShow(e){this.currentUnitsId=this.currentUnitsId.filter((t=>t!==e)),this._showForTree()}removeUnit(e){let t=this.compareConfig.unitsData.find((t=>t.gameId===e));if(!t)return;this.compareConfig.unitsData=this.compareConfig.unitsData.filter((e=>e.gameId!==t.gameId));let i=window.app.getCookie("unitsCompare"),n=[];try{n=JSON.parse(i)}catch(e){n=[]}Array.isArray(n)||(n=[]),n=n.filter((e=>e!==t.gameId)),0===n.length?window.app.deleteCookie("unitsCompare"):window.app.setCookie("unitsCompare",JSON.stringify(n));let s=t.tree;this.trees[s].unitCount--,0===this.trees[s].unitCount?(this.trees[s].tabButton.remove(),delete this.trees[s],this.setCurrentTree(null)):(this.trees[s].tabButton.querySelector(".badge").innerText=this.trees[s].unitCount,this.nodes.buttonSelectTreeDropdown.innerHTML=this.trees[s].tabButton.innerHTML,this.currentUnitsId.includes(t.gameId)&&this.removeFromShow(t.gameId))}},"unit-collection":class{constructor(){let e=document.getElementById("unit-collection_feed");if(e){this.feed=l.init(e);let t=document.getElementById("unit-collection_feed-nav");t&&t.addEventListener("click",(e=>{let i=e.target.closest("[data-feed-sort]");if(i){let e=i.getAttribute("data-feed-sort");this.feed.atributes.sort=e,t.querySelectorAll(".active[data-feed-sort]").forEach((e=>{e.classList.remove("active")})),i.classList.add("active"),this.feed.refresh()}}))}}},ticket:Ne.A,"ticket-list":class{constructor(){let e=document.getElementById("modal-new-ticket"),t=e.querySelector(".comment-form");this.btnSendTicketElem=document.getElementById("modalBtnSendTicket"),this.btnSendTicketElem&&t&&(this.commentForm=new m.A(t,{target:"ticket"}),this.btnSendTicketElem.addEventListener("click",(()=>{this.create()})),e.addEventListener("show.bs.modal",(()=>{this.commentForm.clear()})))}_isProcess=!1;async create(){if(this._isProcess)return Promise.reject();let e=this.commentForm.getValues();if(!("text"in e&&0!==e.text.trim().length||"img-uuid"in e))return window.app.warning(window.app.l10n("comment.error_empty")),Promise.reject();this._isProcess=!0;var t=new FormData;t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),"text"in e&&t.append("text",e.text.trim()),"img-uuid"in e&&t.append("img-uuid",e["img-uuid"]);let i=this.btnSendTicketElem.innerText;return this.btnSendTicketElem.innerHTML=a.A,this.btnSendTicketElem.disabled=!0,(0,s.A)("/api/createTicket",{method:"POST",credentials:"include",body:t}).then((e=>{e.success?(window.app.success(window.app.l10n("report-popup.send")),window.location.href="/u/tickets/"+e.data.ticket_id):window.app.error(e.message)})).finally((e=>{this._isProcess=!1,this.btnSendTicketElem.innerText=i,this.btnSendTicketElem.disabled=!1}))}}},je={"layout-theme-switcher":class{static call(e){let t=e.querySelector(".layout-nav_theme-selector"),i=e=>{window.app.setTheme(e.getAttribute("data-theme")),t.innerText=e.innerText.trim()},n=e.querySelector(".dropdown-menu");n.addEventListener("click",(e=>{let t=e.target.closest("[data-theme]");t&&i(t)}));let s="auto",r=localStorage.getItem("preferTheme");"light"!==r&&"dark"!==r||(s=r);let a=n.querySelector(`[data-theme="${s}"]`);a&&i(a)}},"unit-list":Re.A,"delete-draft":class{static init(){document.addEventListener("click",(e=>{let t=e.target.closest('[data-module="delete-draft"]');if(t){let e=parseInt(t.getAttribute("data-post-id"));Ue.getOrCreateInstance().open(e)}}))}},"comment-mod":Oe.A,"comment-rules":class{static call(e){e.addEventListener("click",(e=>{He.getOrCreateInstance().open()}))}},"markdown-help":De.A,"bs-auto-tooltip":$e.A,"login-button":class{static call(e){const t=()=>{e.classList.remove("loading"),e.classList.add("loaded"),e.addEventListener("click",(()=>{window.GSEA.open()}))};window.GSEA?t():(window.GSEA_init=window.GSEA_init??{onLoad:[]},window.GSEA_init.onLoad.push(t))}},"info-block-place":Ve};new n.A(ze,je)},633:(e,t,i)=>{i.d(t,{A:()=>o});var n=i(202);const s="asjs",r=`.${s}`,a='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg>';class o{constructor(e,t={}){this.formName=t.formName||"",this._isInitialize=!1,this.placeholder=t.placeholder||"",this.emptyPlaceholder=t.emptyPlaceholder||window.app.l10n("selector.list_empty"),this.newPlaceholder=t.newPlaceholder||window.app.l10n("selector.add_new"),this.limitPlaceholder=t.limitPlaceholder||window.app.l10n("selector.limit"),this.selectedPlaceholder=this.selectedPlaceholder||window.app.l10n("selector.selected"),this.maxSize=t.maxSize||null,this.multiselect=t.multiselect||!1,this.sortable=t.sortable||!1,this.allowNew=t.allowNew||!1,this.required=t.required||!1;let i=document.createElement("div");if(i.className=s,this.items=t.items||[],this.values=[],this._selectItems={},this.searchEndpoint=t.searchEndpoint||void 0,this.searchFunction=t.searchFunction||void 0,this.newItemFilter=t.newItemFilter||void 0,this.onChange=t.onChange||void 0,this.multiselect){let e=document.createElement("div");e.className=`${s}_badge-wrapper`,this.badgesWrapper=e,i.append(e)}else{let e=document.createElement("div");e.className=`${s}_input-wrapper ${s}_fake-input`,e.style.display="none",this.fakeInputWrapper=e;let t=document.createElement("div");t.className=`${s}_input form-control form-control-sm`,e.append(t),this.fakeInput=t;let r=document.createElement("div");r.className=`${s}_input-controls`;var n=document.createElement("div");n.className=`${s}_btn-delete ${s}_input-control`,this.required?n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>':n.innerHTML=a,n.addEventListener("click",(()=>{this.fakeInputWrapper.style.display="none",this.inputWrapper.style.display=null,this.required?this.openResults():this.clearValues()})),this.buttonFakeInput=n,r.append(n),e.append(r),i.append(e)}let o=document.createElement("div");o.className=`${s}_input-wrapper`,this.inputWrapper=o;let l=document.createElement("input");l.className=`${s}_input form-control form-control-sm`,l.type="text",this.placeholder&&(l.placeholder=this.placeholder),this.mainInput=l,o.append(l);let d=document.createElement("select");if(d.className=`${s}_select`,""!==this.formName&&(d.name=this.formName,this.multiselect&&(d.name+="[]",d.multiple=!0)),this.required&&(d.required=!0),o.append(d),this.formSelect=d,this.searchFunction||this.searchEndpoint){let e=document.createElement("div");e.className=`${s}_input-controls`;var c=document.createElement("div");c.className="spinner-border spinner-border-sm",c.style.display="none",e.append(c),this.loadSpinner=c,o.append(e)}i.append(o);let u=document.createElement("div");u.className=`${s}_popover shadow`,u.style.display="none",document.addEventListener("click",(e=>{e.target.closest(r)!==this.root&&this.closeResults()}));let h=document.createElement("div");h.className=`${s}_results`,u.append(h),this.results=h,i.append(u),this.popover=u,this.mainInput.addEventListener("focus",(()=>{this.openResults()})),this.mainInput.addEventListener("input",(()=>{this.openResults()})),this.mainInput.addEventListener("keyup",(e=>{"Enter"===e.code&&this.allowNew&&(e.preventDefault(),this.setItem(this.mainInput.value.trim()),this.closeResults())})),e.append(i),this.root=i,this.multiselect&&this.sortable&&window.app.loadModule("sortable").then((({default:e})=>{i.classList.add(`${s}--sortable`),new e.Sortable(this.badgesWrapper,{animation:150,handle:`${r}_badge-label`,ghostClass:`${s}_badge--ghost`,onUpdate:e=>{this.values.splice(e.newIndex,0,this.values.splice(e.oldIndex,1)[0]),this._regenSelect()}})})),t.values&&t.values.forEach((e=>{this.setItem(e)})),this._isInitialize=!0}openResults(){this.popover.style.display=null,this._filterSearch()}closeResults(){this.popover.style.display="none",this.required&&!this.multiselect&&0!==this.values.length&&(this.fakeInputWrapper.style.display=null,this.inputWrapper.style.display="none"),this.results.innerHTML=""}_filterSearch(){let e=this.mainInput.value.trim(),t=[];if(this.maxSize&&this.values.length>=this.maxSize)this._renderResults(t,e);else if("function"==typeof this.searchFunction||this.searchEndpoint)this.loadSpinner.style.display=null,void 0!==this.timer&&clearTimeout(this.timer),this.timer=setTimeout((()=>{let t;this.timer=void 0,t=this.searchFunction?this.searchFunction(e,this.values):(0,n.A)(this.searchEndpoint+new URLSearchParams({q:e,e:this.values})),t.then((t=>{this.items=t,this._renderResults(t,e)})).finally((()=>{this.loadSpinner.style.display="none"}))}),250);else{if(""===e&&0===this.values.length)t=this.items;else{let i=e.toLowerCase();this.items.forEach((e=>{let n,s=void 0!==e.value?e.value:e;if(-1!==this.values.indexOf(s))return;if(!e.searchString&&e.searchHTML){var r=document.createElement("div");r.innerHTML=e.searchHTML,n=r.innerText}let a=e.searchString||n||e.value||e;a=a.toString().toLowerCase(),-1!==a.indexOf(i)&&t.push(e)}))}this._renderResults(t,e)}}_renderResults(e,t){if(this.results.innerHTML="",this.maxSize&&this.values.length>=this.maxSize){let e=document.createElement("div");return e.className=`${s}_result-item`,e.innerHTML=this.limitPlaceholder,void this.results.append(e)}if(this.required&&!this.multiselect&&0!==this.values.length){let e=this.values[0],t=this._selectItems[e],i=document.createElement("div");i.className=`${s}_result-item`,i.setAttribute("data-label",this.selectedPlaceholder),i.innerHTML=t.searchHTML||t.value||t,i.addEventListener("click",(()=>{this.closeResults()})),this.results.append(i)}let i=null;if(this.allowNew&&""!==t&&(i="function"==typeof this.newItemFilter?this.newItemFilter(t):t,i)){let t=i.value||i;(-1!==this.values.indexOf(t)||e.find((e=>{if(e.value===t||e===t)return!0})))&&(i=null)}if(i){let e=document.createElement("div");e.className=`${s}_result-item`,e.setAttribute("data-label",this.newPlaceholder),e.innerHTML=i.searchHTML||i.value||i,e.addEventListener("click",(()=>{this.setItem(i),this.closeResults()})),this.results.append(e)}if(0!==e.length||i)e.forEach((e=>{let t=document.createElement("div");t.className=`${s}_result-item`,t.innerHTML=e.searchHTML||e.value||e,t.addEventListener("click",(()=>{this.setItem(e),this.closeResults()})),this.results.append(t)}));else{let e=document.createElement("div");e.className=`${s}_result-item`,e.innerHTML=this.emptyPlaceholder,this.results.append(e)}}getValues(){return this.values}setItem(e){if(this.maxSize&&this.values.length>=this.maxSize)return;let t=void 0!==e.value?e.value:e;if(-1!==this.values.indexOf(t))return;let i=this.items.find((e=>{if(e.value===t||e===t)return!0}));if(i)e=i;else if(this._isInitialize){if(!this.allowNew)return;if("function"==typeof this.newItemFilter&&!(e=this.newItemFilter(t)))return}if(this.multiselect){let i=document.createElement("div");i.className=`${s}_badge`;let n=document.createElement("div");n.innerHTML=e.badgeHTML||e.searchHTML||t,n.className=`${s}_badge-label`,i.append(n);let r=document.createElement("button");r.innerHTML=a,r.className=`${s}_badge-delete`,r.addEventListener("click",(()=>{this.removeValue(t),i.remove()})),i.append(r),this.badgesWrapper.append(i)}else this.clearValues(),this.fakeInput.innerHTML=e.badgeHTML||e.searchHTML||t.toString(),this.fakeInputWrapper.style.display=null,this.inputWrapper.style.display="none";this.values.push(t),this._selectItems[t]=e;let n=document.createElement("option");n.value=t,n.selected=!0,this.formSelect.append(n),this.mainInput.value="",this._isInitialize&&"function"==typeof this.onChange&&this.onChange(this)}removeValue(e){this.values=this.values.filter((t=>t!==e)),this._regenSelect(),this._isInitialize&&"function"==typeof this.onChange&&this.onChange(this)}clearValues(){this.values=[],this.formSelect.innerHTML="",this.results.innerHTML="",this.badgesWrapper&&(this.badgesWrapper.innerHTML=""),this._isInitialize&&"function"==typeof this.onChange&&this.onChange(this)}_regenSelect(){this.formSelect.innerHTML="",this.values.forEach((e=>{let t=document.createElement("option");t.value=e,t.selected=!0,this.formSelect.append(t)}))}}},86:(e,t,i)=>{i.d(t,{i:()=>a});var n=i(633),s=i(202);const r="/api/category_search";function a(e,t=[],i=void 0){return new n.A(e,{placeholder:window.app.l10n("tag-selector.placeholder"),emptyPlaceholder:window.app.l10n("tag-selector.empty"),newPlaceholder:window.app.l10n("tag-selector.new"),limitPlaceholder:window.app.l10n("tag-selector.limit",{limit:10}),maxSize:10,allowNew:"0"!==e.getAttribute("data-allow-custom"),multiselect:!0,sortable:!0,values:t,newItemFilter:e=>/[a-zа-яё0-9-_ ]{2,32}/iu.test(e)?{value:e,searchHTML:"#"+e,badgeHTML:"#"+e}:null,searchFunction:async(e,t)=>{const i=await(0,s.A)(r+"?"+new URLSearchParams({q:e,e:t}));let n=[];return i.forEach((e=>{let t={};if(t.value=e.tag,t.badgeHTML=e.title,t.searchHTML=`<div class="select-category-title">${e.title}</div>`,e.desc&&(t.searchHTML+=`<div class="select-category-desc">${e.desc}</div>`),e.keywords&&e.keywords.length>0){let i="<span>"+e.keywords.join("</span><span>")+"</span>";t.searchHTML+=`<div class="select-category-keywords">${i}</div>`}n.push(t)})),n},onChange:i})}},267:(e,t,i)=>{i.d(t,{A:()=>r});var n=i(252),s=i(400);class r{constructor(e,t={}){if(this.root=e,this.nodes={formInput:this.root.querySelector(".comment-form_input"),fileButton:this.root.querySelector(".comment-form_upload-file"),imgPreloader:this.root.querySelector(".img-preloader"),imgAttach:this.root.querySelector(".comment-form_attach-img")},this.onSend=t.onSend||void 0,this.target=t.target,this.nodes.formInput){let e=parseInt(this.nodes.formInput.getAttribute("maxlength")),t=this.root.querySelector(".comment-form_limit"),i=()=>{t&&(this.nodes.formInput.value.length+50>e?t.textContent=`${this.nodes.formInput.value.length}/${e}`:t.textContent="",this.nodes.formInput.value.length>=e?t.classList.add("text-danger"):t.classList.remove("text-danger"))};this.nodes.formInput.addEventListener("input",i);let n=()=>{this.nodes.formInput.style.height=0,this.nodes.formInput.style.height=this.nodes.formInput.scrollHeight+"px"};this.root.resizeHeight=n,this.nodes.formInput.addEventListener("input",n)}if(this.nodes.fileButton){var i=new n.A;this.nodes.imgAttach.addEventListener("click",(()=>{this.nodes.fileButton.classList.remove("d-none"),this.root.removeAttribute("data-img-uuid"),this.nodes.imgAttach.classList.add("d-none"),this.nodes.imgAttach.style.backgroundImage=null}));var r=document.createElement("input");r.type="file",r.accept="image/png, image/jpeg, image/gif, image/webp",r.onchange=e=>{var t=e.target.files[0];this.nodes.fileButton.classList.add("d-none"),this.nodes.imgPreloader.classList.remove("d-none");var n=new FileReader;n.readAsDataURL(t),n.onload=e=>{this.nodes.imgPreloader.style.backgroundImage=`url(${e.target.result})`},i.upload(t,this.target).then((e=>{this.nodes.imgPreloader.classList.add("d-none"),this.nodes.imgAttach.classList.remove("d-none"),this.nodes.imgAttach.style.backgroundImage=`url(${e.file.url})`,this.root.setAttribute("data-img-uuid",e.file.uuid),r.value=""})).catch((e=>{this.nodes.imgPreloader.classList.add("d-none"),r.value="",window.app.error(e.message)}))},this.nodes.fileButton.addEventListener("click",(e=>{r.click()}))}var a=this.root.querySelector(".comment-form_send");a&&this.onSend&&(this._inProcess=!1,a.addEventListener("click",(e=>{if(this._inProcess)return;this._inProcess=!0;let t=a.innerText;a.innerHTML=s.A,a.disabled=!0;let i=this.getValues();this.onSend(i,this.root).then((e=>{this.clear()})).finally((e=>{this._inProcess=!1,a.innerText=t,a.disabled=!1}))})))}getValues(){let e={};this.root.hasAttribute("data-img-uuid")&&(e["img-uuid"]=this.root.getAttribute("data-img-uuid"));let t=this.root.querySelector(".comment-form_input").value.trim();return t.length>0&&(e.text=t),e}clear(){this.nodes.formInput&&(this.root.removeAttribute("data-img-uuid"),this.nodes.formInput.value="",this.nodes.fileButton.classList.remove("d-none"),this.nodes.imgPreloader.classList.add("d-none"),this.nodes.imgAttach.classList.add("d-none"))}}},193:(e,t,i)=>{i.d(t,{T:()=>o,Y:()=>a});var n=i(633),s=i(202);const r="/api/searchUnitCollection";function a(e){if("u"===e.type){let t={};t.value="u:"+e.id;let i=`<img class="icon" src="${e.preview_url}">`,n=`<img class="flag" src="/static/country_svg/country_${e.country_id}.svg">`,s=`<span>${e.country_name}</span>`,r=`<div class="title">${e.name}</div>`,a=["post-unit"];switch(e.exp_type){case 0:a.push("post-unit--regular");break;case 1:a.push("post-unit--prem");break;case 2:a.push("post-unit--squad")}let o=`<div class="${a.join(" ")}">${i}<div><div class="sub-cat">${n}${s}</div>${r}</div></div>`;return t.badgeHTML=o,t.searchHTML=o,t}if("c"===e.type){let t={};t.value="c:"+e.id;let i='<div class="icon"><i class="bi bi-folder2-open"></i></div>',n=`<div class="title">${e.title}</div>`,s=`<div class="post-unit">${i}<div><div class="sub-cat">${e.group_title}</div>${n}</div></div>`;return t.badgeHTML=s,t.searchHTML=s,t}return null}function o(e,t=[],i=void 0){return new n.A(e,{placeholder:window.app.l10n("unit-selector.placeholder"),emptyPlaceholder:window.app.l10n("unit-selector.empty"),limitPlaceholder:window.app.l10n("selector.limit"),maxSize:10,allowNew:!1,multiselect:!0,values:t,searchFunction:async(e,t)=>{const i=await(0,s.A)(r+"?"+new URLSearchParams({q:e,e:t}));let n=[];return i.forEach((e=>{let t=a(e);null!==t&&n.push(t)})),n},onChange:i})}},252:(e,t,i)=>{i.d(t,{A:()=>s});var n=i(202);class s{upload(e,t=null){var i=new FormData;return i.append("image_file",e,"img"),i.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t&&i.append("target",t),this._makeRequest(i)}async _makeRequest(e){return(0,n.A)("/api/upload",{method:"POST",credentials:"include",body:e}).then((e=>{if(e.success)return e;throw new Error(e.message)}))}}},282:(e,t,i)=>{i.d(t,{A:()=>n});class n{static render(e){let t=document.createElement("template");t.innerHTML=e;let i=t.content.firstChild;return i.querySelectorAll("[data-l10n-key]").forEach((e=>{let t=e.getAttribute("data-l10n-key");e.removeAttribute("data-l10n-key"),e.innerHTML=window.app.l10n(t)})),i}}},865:(e,t,i)=>{i.d(t,{A:()=>n});class n{constructor(e){this.node=e,this._firstDirection="asc",this._sortFunctions={};var t=e.querySelector(".wt-ulist_instance"),i=e.querySelectorAll(".wt-ulist_header th");i.forEach(((e,n)=>{if(!e.classList.contains("wt-ulist_header-button"))return;let s=null,r=e.hasAttribute("data-sort-key");s=r?e.getAttribute("data-sort-key"):n,this._sortFunctions[s]=a=>{var o="string";"n"===e.getAttribute("data-sort-type")&&(o="number");let l=Array.from(t.tBodies[0].rows).sort(((e,t)=>this._listSortFunction(e,t,n,o,a)));t.tBodies[0].append(...l),r?(this.setURLParam("l_sk",s),this.setURLParam("l_sd",a)):(this.setURLParam("l_sk",null),this.setURLParam("l_sd",null)),this._setHeaderDirection(i,e,a)},e.addEventListener("click",(()=>{var t=this._firstDirection;e.classList.contains("active--top")?t="asc":e.classList.contains("active--bottom")&&(t="desc"),this.listSort(s,t)}))})),null!==this.getURLParam("l_sk")&&this.listSort(this.getURLParam("l_sk"),this.getURLParam("l_sd"))}getURLParam(e){return new URL(window.location.href).searchParams.get(e)}setURLParam(e,t){var i=new URL(window.location.href);null===t?i.searchParams.delete(e):i.searchParams.set(e,t),window.history.replaceState(null,null,i)}listSort(e,t=this._firstDirection){this._sortFunctions.hasOwnProperty(e)&&this._sortFunctions[e](t)}_setHeaderDirection(e,t,i){e.forEach((e=>{e.classList.remove("active--top"),e.classList.remove("active--bottom")})),"asc"==i?t.classList.add("active--bottom"):t.classList.add("active--top")}_listSortFunction(e,t,i,n,s){"asc"!==s&&"desc"!==s&&(s=this._firstDirection);var r=e.cells[i],a=t.cells[i],o=r.hasAttribute("data-value")?r.getAttribute("data-value"):r.innerText,l=a.hasAttribute("data-value")?a.getAttribute("data-value"):a.innerText;if("number"==n&&(o=Number(o),l=Number(l)),o==l){var d=e.getAttribute("data-ulist-id"),c=t.getAttribute("data-ulist-id");return"asc"==s?d>c?1:-1:d<c?1:-1}return"asc"==s?o>l?1:-1:o<l?1:-1}}},25:(e,t,i)=>{i.d(t,{A:()=>r});var n=i(202),s=i(267);class r{constructor(){let e=document.getElementById("mainBlock"),t=document.querySelector(".comment-form");if(t){let i=parseInt(e.getAttribute("data-ticket-id"));this.commentForm=new s.A(t,{target:"ticket_"+i,onSend:async e=>{if(!("text"in e&&0!==e.text.trim().length||"img-uuid"in e))return window.app.warning(window.app.l10n("comment.error_empty")),Promise.reject();var t=new FormData;return t.append(window.app.getCSRFParam(),window.app.getCSRFToken()),t.append("ticket_id",i),"text"in e&&t.append("text",e.text.trim()),"img-uuid"in e&&t.append("img-uuid",e["img-uuid"]),(0,n.A)("/api/ticketCommentSend",{method:"POST",credentials:"include",body:t}).then((e=>{e.success?window.location.reload():window.app.error(e.message)}))}})}}}},503:(e,t,i)=>{i.d(t,{A:()=>s});var n=i(336);class s{static init(e){[...document.querySelectorAll('[data-bs-toggle="tooltip"]')].map((e=>new n.Tooltip(e,{trigger:"hover"})))}}},59:(e,t,i)=>{i.d(t,{A:()=>n});class n{static init(){document.addEventListener("click",(e=>{let t=e.target.closest('[data-module="comment-mod"]');t&&i.e(189).then(i.bind(i,629)).then((({default:e})=>{let i=t.closest("[data-comment-id]");if(!i)return;let n=parseInt(i.getAttribute("data-comment-id"));e.getOrCreateInstance().open(n)})).catch((e=>{window.app.error(window.app.l10n("core.module-load-error")),console.error(e)}))}))}}},649:(e,t,i)=>{i.d(t,{A:()=>a});var n=i(336),s=i(282);class r{static _instance=null;static getOrCreateInstance(){return r._instance||(r._instance=new r),r._instance}constructor(){let e=s.A.render('<div class="modal fade" id="markdownHelpModal" tabindex="-1" aria-modal="true" role="dialog" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h1 class="modal-title fs-5" data-l10n-key="markdown-help-popup.title"></h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <div class="block-table"> <table class="mb-2 w-100"> <thead> <tr> <th data-l10n-key="markdown-help-popup.header-syntax"></th> <th data-l10n-key="markdown-help-popup.header-example"></th> </tr> </thead> <tbody> <tr> <td><code>**<span data-l10n-key="markdown-help-popup.label-bold"></span>**</code></td> <td> <div class="content-markdown fs-6"> <b data-l10n-key="markdown-help-popup.label-bold"></b> </div> </td> </tr> <tr> <td><code>*<span data-l10n-key="markdown-help-popup.label-italic"></span>*</code></td> <td> <div class="content-markdown fs-6"> <i data-l10n-key="markdown-help-popup.label-italic"></i> </div> </td> </tr> <tr> <td><code>&gt; <span data-l10n-key="markdown-help-popup.label-quote"></span></code></td> <td> <div class="content-markdown fs-6"> <blockquote data-l10n-key="markdown-help-popup.label-quote"></blockquote> </div> </td> </tr> <tr> <td><code>[<span data-l10n-key="markdown-help-popup.label-link"></span>](https://example.com)</code></td> <td> <div class="content-markdown fs-6"> <a href="https://example.com" target="_blank" data-l10n-key="markdown-help-popup.label-link"></a> </div> </td> </tr> </tbody> </table> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-l10n-key="button_close"></button> </div> </div> </div> </div>');document.body.appendChild(e),this.node=e,this.bsModal=n.Modal.getOrCreateInstance(e)}open(){this.bsModal.show()}}class a{static call(e){e.addEventListener("click",(e=>{r.getOrCreateInstance().open()}))}}},809:(e,t,i)=>{i.d(t,{A:()=>s});var n=i(865);class s{static call(e){return new n.A(e)}}}},e=>{e(e.s=641)}]);